# CaleNote - アプリ仕様書

## この仕様書について

**重要**: この仕様書は**実装準拠**です。つまり、現在動作しているコードを「仕様」として明文化したものです。理想や将来の計画ではなく、**今動いている実装が唯一の真実**です。

- 実装済みの機能は確定仕様として記載
- 未実装の機能は「未実装」または「制限」として明記
- Google Calendarは**唯一の永続データストア**であり、アプリ内のSwiftDataはキャッシュにすぎない
- 実装の詳細（`extendedProperties.private`の構造など）は仕様として固定

この方針により、次の担当者が「なぜこうなっているのか」を理解しやすくし、事故を防ぎます。

---

## 1. 概要

### 1.1 アプリ名
**CaleNote**（Calendar + Note）

### 1.2 コンセプト
Googleカレンダーを**唯一の真実のソース（Single Source of Truth）**として利用し、日々の出来事や内省を「書く」のではなく「存在させる」ジャーナルアプリ。**Googleカレンダーが唯一の永続データストア**であり、アプリ内のSwiftDataはキャッシュおよび編集補助にすぎない。カレンダーの予定と一緒に1日単位で振り返ることができ、過去の同じ日を振り返る機能で、自分の歩みを実感できる。

### 1.3 ターゲットユーザー
- 日々の出来事や思考を手軽に記録したい人
- Googleカレンダーで予定管理している人
- 後から振り返り・検索したい人

### 1.4 プラットフォーム
- iOS 17.0以上
- iPhone対応（iPad対応は将来検討）

---

## 1.5 データ保存方針

**重要**: Google Calendarは「外部保存」ではなく、**唯一の永続データストア**である。アプリ内のSwiftDataはキャッシュおよび編集補助にすぎない。

| データ種別 | 保存先 | 備考 |
|-----------|--------|------|
| ジャーナル本文・メタ情報 | 端末内（SwiftData） | **キャッシュ**。Google Calendarが正 |
| 写真 | 端末内ファイル保存 + SwiftData参照 | ローカル保存（Google Calendarには保存しない） |
| 設定情報 | UserDefaults | ローカル保存 |
| 認証トークン | Keychain | セキュア保存 |
| **永続データストア** | **Google Calendar（イベント）** | **唯一の真実のソース** |
| クラッシュレポート等 | Firebase（Crashlytics / App Distribution / Remote Config） | ユーザーデータ保存は行わない |

### 1.5.1 キャッシュの2層構造

アプリは2種類のキャッシュを管理する：

**短期キャッシュ（CachedCalendarEvent）**
- 同期対象期間内のイベントを保持
- Timeline描画用
- 同期範囲外のデータは定期的に削除される（`CalendarCacheCleaner`）

**長期キャッシュ（ArchivedCalendarEvent）**
- 全期間のイベントを保持（2000年1月1日〜未来1年）
- 振り返り・検索用
- 設定画面から明示的に取り込む必要がある（`ArchiveSyncService`）
- 半年単位でAPI取得、レート制限対策として0.2秒のsleep挿入
- **レート制限対応**: 指数バックオフ + ジッター（自動リトライ、最大5回、最大60秒待機）
- **キャンセル機能**: 取り込み中にキャンセル可能。進捗はUserDefaultsに保存され、再開時に続きから実行
- **進捗保存**: カレンダー×半年レンジ単位で進捗を記録。中断・再開に対応

**注意**: CloudKitやその他のクラウド同期は**当面実装しない**。Google Calendarが唯一の外部永続先である。

---

## 2. 機能要件

### 2.1 ジャーナル機能（コア機能）

#### 2.1.1 エントリの構成要素

| 項目 | 必須 | 説明 |
|------|------|------|
| タイトル | 任意 | 短い見出し |
| 本文 | 必須 | メインのテキスト。ハッシュタグ対応 |
| 日時 | 自動 | 作成日時（手動変更可） |
| カラー | 任意 | カラーパレットから選択（デフォルト: ミュートブルー） |
| 場所 | 任意 | 位置情報または手入力 |
| 写真 | 任意 | 複数枚添付可 |

#### 2.1.2 ハッシュタグ機能

**基本方針**
- タグは `#tag` 形式で本文中に記述する
- Google Calendar 側には **description に本文 + 改行 + タグ** を保存する
- タグは独立したデータ構造として Google Calendar には持たせない

**アプリ内での扱い**
- 保存・更新時に本文から `#tag` をパース
- タグは SwiftData 内でインデックス化（エントリとの関連のみ保持）
- 全期間のタグ一覧は作成しない

**表示・UI**
- 表示するタグは「最近使われたタグ」のみ
- 最近の定義: ローカルキャッシュ（同期対象期間）内での使用頻度・直近使用日時
- タグ一覧は最大10件程度を想定

**検索**
- 検索バーに `#tag` を入力するとタグ検索として機能
- タグ一覧からの選択は「最近使ったタグ」に限定

#### 2.1.3 位置情報
- 設定でデフォルト動作を選択可能
  - 「現在位置を自動取得」ON/OFF
- 個別エントリで位置を変更・削除可能
- 手入力で場所名を設定可能

#### 2.1.4 入力方法
**Phase 1（MVP）**
- アプリ内から手動入力
- 新規作成ボタン（FAB）

**Phase 2（将来）**
- ホーム画面ウィジェットから素早く入力

### 2.2 タイムライン表示

- **逆時系列**で表示（新しいエントリが上、古いものが下）
- Googleカレンダーの予定とジャーナルを統合表示
- **予定とジャーナルは完全に統一されたカードデザインで表示**（区別しない）
- カードの背景色はユーザーが選択したカラーパレットから適用
- カードのアイコンは、設定でカレンダーごとに選択したアイコンパレットから適用
- 日付区切りを表示

### 2.3 カレンダー機能

- カレンダーボタンタップでカレンダーモーダル/シートを表示
- 月表示カレンダー
- **ジャーナルがある日にドットマーカー表示**
- 日付タップでその日のタイムライン位置にスクロール/遷移

### 2.4 Googleカレンダー連携

#### 2.4.1 認証
- Google Sign-In SDK使用
- Calendar API読み取り・書き込み権限

#### 2.4.2 カレンダー選択
- 複数カレンダーから表示対象を選択
- カレンダーごとの表示ON/OFF（`CachedCalendar.isEnabled`）

#### 2.4.3 予定の表示
- タイムライン上に予定を表示（参照のみ）
- 予定のカード背景色は、設定でカレンダーごとに選択したカラーパレットから適用
- 予定のカードアイコンは、設定でカレンダーごとに選択したアイコンパレットから適用

#### 2.4.4 同期範囲（実装準拠）
- **デフォルト: 過去30日〜未来30日**（`SyncSettings`）
- ユーザーが設定画面で変更可能（UserDefaults管理）
- 同期対象はイベントの必要最小限フィールド（title / description / start / end / updated / status / extendedProperties 等）
- タグ抽出は同期対象期間内のイベント description から行う
- タグ一覧・頻出度はこの範囲のみで構築
- 全期間のタグ網羅は行わない（古いタグを探したい場合は、手入力検索で対応）

#### 2.4.5 Google Calendarを正とする設計

**ジャーナルとイベントの1:1対応**
- 1つの`JournalEntry`は1つのGoogle Calendar Eventと対応する
- 対応関係は`extendedProperties.private`によって保証される
- このJSON構造は**確定仕様**である：

```json
extendedProperties.private = {
  "app": "calenote",
  "schema": "1",
  "journalId": "<UUID文字列>"
}
```

**双方向同期の仕組み**
- ジャーナル → カレンダー: `JournalCalendarSyncService`が`insertEvent`/`updateEvent`を実行
- カレンダー → ジャーナル: `CalendarToJournalSyncService`が`CachedCalendarEvent`の変更を`JournalEntry`に反映
- `description`の編集有無に依存せず、`extendedProperties.private`の`journalId`で紐付けを判定
- サーバーを介さず双方向同期が成立する理由は、この実装依存仕様による

**競合処理（実装準拠）**
- Googleカレンダー側の`updated`が新しければアプリを更新
- ローカルとカレンダーの両方が更新された場合（競合検知条件）:
  - 既にリンク済み（`linkedEventUpdatedAt`存在）かつ
  - ローカルがカレンダーより新しく（`entry.updatedAt > calendarUpdatedAt`）
  - 30秒以上の差がある場合に競合と判定
- 競合時は`JournalEntry`に競合フラグを設定し、カレンダー版のスナップショットを保存
- ユーザーに競合解決UIを表示（`ConflictResolutionView`）、ローカル版・カレンダー版のどちらを採用するか選択可能
- イベントが`status == "cancelled"`の場合は、ジャーナルのリンクを解除（`linkedEventId = nil`）

#### 2.4.6 同期仕様（実装準拠）

**同期トリガー**
- アプリ起動時（推測、実装確認要）
- メイン画面 pull-to-refresh（手動同期）
- 設定画面からの明示的操作

**差分同期**
- `events.list` + `syncToken`を使用
- `showDeleted=true`必須
- `status == "cancelled"`は削除扱い
- `syncToken`が期限切れ（HTTP 410 GONE）の場合はフル同期にフォールバック
- 同期状態はカレンダーごとに`CalendarSyncState`で管理（UserDefaults）

**レート制限**
- `SyncRateLimiter`により、5秒間隔で同期を制限
- 手動同期時は残り秒数を表示
- **指数バックオフ + ジッター**: HTTP 429（Too Many Requests）またはHTTP 403で`rateLimitExceeded`/`userRateLimitExceeded`を検出した場合、自動リトライ
  - 最大リトライ回数: 5回
  - 最大待機時間: 60秒
  - 計算式: `delay = min(baseDelay * 2^attempt + jitter, maxWaitTime)`
  - ジッター: `random(0..<0.5) * exponentialDelay`（サンダリングハード防止）
  - リトライメトリクスは`SyncLog`に記録（`retryCount`, `totalWaitTime`）

**更新優先度**
- Googleカレンダー側の`updated`が新しければアプリを更新
- ローカルが新しくても競合時は**安全側にスキップ**（`CalendarToJournalSyncService`）

### 2.5 過去の同じ日を振り返り機能

- 今日と同じ月日の過去エントリを表示
- 「1年前」「5年前」「10年前」などの節目を強調
- タイムライン上部または専用セクションに表示

### 2.6 検索機能

- 画面上部に検索バー配置
- フリーテキスト検索（タイトル、本文、ハッシュタグ）
- 検索バーに `#tag` を入力するとタグ検索として機能
- 検索結果はタイムライン形式で表示
- タグ一覧からの選択は「最近使ったタグ」に限定（最大10件程度）

### 2.7 競合解決機能

#### 2.7.1 競合検知

ローカルとGoogle Calendar両方でジャーナルが変更された場合に競合を検知する。

**検知条件**:
- `linkedEventUpdatedAt`が存在する（既にカレンダーと同期済み）
- `entry.updatedAt > calendarUpdatedAt`（ローカルの方が新しい）
- 差分が30秒以上（タイムスタンプのずれによる誤検知を防ぐ）

**競合時の動作**:
- `hasConflict = true`を設定
- カレンダー版のスナップショットを保存（title, body, updatedAt, eventDate）
- 同期ステータスに競合カウントを表示
- タイムライン上にオレンジの三角バッジを表示

#### 2.7.2 競合解決UI

**JournalDetailView**:
- 競合状態の場合、メタデータセクションに警告表示
- 「競合を解決」ボタンを表示（オレンジ）

**ConflictResolutionView（モーダル）**:
- ローカル版とカレンダー版を並べて表示
- 各版の表示内容: タイトル、本文、更新日時、イベント日時
- 「この版を使う」ボタンで解決方法を選択

**解決方法**:
- **useLocal**: ローカル版を採用し、カレンダーに再送信（`needsCalendarSync = true`）
- **useRemote**: カレンダー版を採用し、ローカルを上書き

**解決後**:
- 競合フラグをクリア（`hasConflict = false`、スナップショットも削除）
- タイムライン上のバッジが消える
- エラー発生時は画面上にエラーメッセージを表示

#### 2.7.3 自動解決

以下の場合は自動的に競合フラグをクリア:
- カレンダーからの変更が正常にローカルに適用された場合
- リモートイベントが削除された場合（`status == "cancelled"`）

---

## 3. 画面構成

### 3.1 画面一覧（2タブ構成）

```
タブ1: メイン画面
├── 検索バー（上部）
├── カレンダーボタン
├── 過去の同じ日セクション
├── タイムライン（逆時系列）
└── 新規作成ボタン（FAB）

タブ2: 設定画面
├── Googleアカウント連携
├── カレンダー選択
├── 位置情報デフォルト設定
├── 表示設定
└── データ管理
```

### 3.2 画面詳細

#### 3.2.1 メイン画面

```
┌─────────────────────────────────┐
│  🔍 検索...              📅    │  ← 検索バー + カレンダーボタン
├─────────────────────────────────┤
│  ┌─────────────────────────┐   │
│  │ 📅 この日の思い出        │   │  ← 過去の同じ日（折りたたみ可）
│  │ 1年前: ○○へ旅行...      │   │
│  └─────────────────────────┘   │
├─────────────────────────────────┤
│  ── 2024年12月20日 ──          │  ← 日付区切り
│  ┌─────────────────────────┐   │
│  │ 📝 14:30               │   │  ← カード（統一デザイン）
│  │ ミーティングメモ        │   │
│  │ 今日の打ち合わせで...    │   │
│  └─────────────────────────┘   │
│  ┌─────────────────────────┐   │
│  │ 📅 13:00-14:00         │   │  ← カード（統一デザイン）
│  │ チームMTG              │   │
│  └─────────────────────────┘   │
│  ┌─────────────────────────┐   │
│  │ 💡 10:15               │   │  ← カード（統一デザイン）
│  │ アイデア               │   │
│  │ 新機能について #仕事    │   │
│  └─────────────────────────┘   │
│                                 │
│  ── 2024年12月19日 ──          │
│  ...                            │
│                                 │
│                          [＋]   │  ← FAB（新規作成）
├─────────────────────────────────┤
│    [メイン]      [設定]         │  ← タブバー
└─────────────────────────────────┘
```

**構成要素**:
- 検索バー（上部固定）
- カレンダーボタン（検索バー右端）
- 過去の同じ日セクション（折りたたみ可能）
- タイムライン（逆時系列、日付区切りあり）
- 新規作成FAB（右下固定）

**インタラクション**:
- 検索バータップ → キーボード表示、検索実行
- カレンダーボタンタップ → カレンダーシート表示
- 予定カードタップ → 予定詳細（読み取りのみ）
- ジャーナルカードタップ → 編集画面
- 過去エントリタップ → 該当日へスクロール
- FABタップ → 新規作成画面
- 下スクロール → 過去のエントリを読み込み

**カードの統一**:
- **予定とジャーナルは完全に統一されたカードデザインを使用**（視覚的な区別は行わない）
- カードの背景色は、カラーパレットから選択した色を適用
- カードのアイコンは、設定でカレンダーごとに選択したアイコンパレットから適用
- ジャーナルエントリ作成時: カラーを選択可能（アイコンはカレンダーごとの設定を使用）
- 予定表示時: 設定でカレンダーごとに選択したカラーとアイコンを適用

#### 3.2.2 カレンダーシート（モーダル）

```
┌─────────────────────────────────┐
│         2024年12月         ▼   │
├─────────────────────────────────┤
│  日  月  火  水  木  金  土    │
│                              1 │
│   2   3   4   5●  6   7   8  │  ← ●はジャーナル記録日
│   9  10  11● 12  13  14  15  │
│  16  17  18  19● 20◉ 21  22  │  ← ◉は今日
│  23  24  25  26  27  28  29  │
│  30  31                       │
└─────────────────────────────────┘
```

**インタラクション**:
- 日付タップ → シート閉じる → その日のタイムラインへ遷移
- 月スワイプ → 前後の月へ移動
- 外側タップ → シート閉じる

#### 3.2.3 ジャーナル作成/編集画面（モーダル）

```
┌─────────────────────────────────┐
│  ✕ 新規エントリ        保存    │
├─────────────────────────────────┤
│  タイトル（任意）              │
│  ─────────────────────────     │
│                                 │
│  今日あったこと...              │
│                                 │
│                                 │
│                                 │
├─────────────────────────────────┤
│  🎨 カラー: ミュートブルー  ▼  │
│  📍 渋谷区（現在地）      ✕    │
│  📷 写真を追加                  │
│  🕐 2024/12/20 14:30     変更  │
└─────────────────────────────────┘
```

**構成要素**:
- 閉じるボタン（左上）
- 保存ボタン（右上）
- タイトル入力欄
- 本文入力欄
- カラー選択（カラーパレットから選択、デフォルト: ミュートブルー）
- 場所（デフォルト設定に応じて自動入力）
- 写真追加ボタン
- 日時表示/変更

#### 3.2.4 設定画面（実装準拠）

```
┌─────────────────────────────────┐
│           設定                  │
├─────────────────────────────────┤
│  Google連携                     │
│  ┌─────────────────────────┐   │
│  │ ログイン中: user@gmail  │   │
│  │ [ログアウト]            │   │
│  └─────────────────────────┘   │
├─────────────────────────────────┤
│  表示するカレンダー             │
│  ┌─────────────────────────┐   │
│  │ ☑ カレンダー1          │   │
│  │ ☐ カレンダー2          │   │
│  │ [カレンダー一覧を再同期] │   │
│  └─────────────────────────┘   │
├─────────────────────────────────┤
│  ジャーナルの書き込み先          │
│  ┌─────────────────────────┐   │
│  │ カレンダー1        ▼    │   │
│  └─────────────────────────┘   │
├─────────────────────────────────┤
│  同期対象期間                   │
│  ┌─────────────────────────┐   │
│  │ 過去 30 日        [-][+] │   │
│  │ 未来 30 日        [-][+] │   │
│  │ （説明文）               │   │
│  └─────────────────────────┘   │
├─────────────────────────────────┤
│  カレンダーの色                 │
│  ┌─────────────────────────┐   │
│  │ カレンダー1          ＞ │   │
│  │ カレンダー2          ＞ │   │
│  └─────────────────────────┘   │
├─────────────────────────────────┤
│  同期待ち                       │
│  ┌─────────────────────────┐   │
│  │ 3件の同期待ちがあります  │   │
│  │ [まとめて再送]          │   │
│  └─────────────────────────┘   │
├─────────────────────────────────┤
│  長期キャッシュ                 │
│  ┌─────────────────────────┐   │
│  │ [長期キャッシュを取り込む]│   │
│  │ （進捗表示）            │   │
│  │ （説明文）               │   │
│  └─────────────────────────┘   │
├─────────────────────────────────┤
│    [メイン]      [設定]         │
└─────────────────────────────────┘
```

**構成要素（実装準拠）**:
- Google連携: ログイン/ログアウト、ログイン成功後は自動的にカレンダー一覧を同期
- 表示するカレンダー: カレンダーごとのON/OFF切り替え、カレンダー一覧の再同期ボタン
- ジャーナルの書き込み先: 新規ジャーナルを書き込むカレンダーを選択（`JournalWriteSettings`）
- 同期対象期間: 過去/未来の日数を設定（1〜365日、デフォルト: 30日、`SyncSettings`）
- カレンダーの色: カレンダーごとにカラーパレットから選択（`CalendarColorPickerView`）
- 同期待ち: `needsCalendarSync == true`のジャーナルを一覧表示、まとめて再送ボタン
- 長期キャッシュ: 全期間のイベントを取り込む（`ArchiveSyncService`）、進捗表示あり

**未実装項目**:
- 位置情報デフォルト設定
- テーマ設定（ダークモード）
- エクスポート/バックアップ機能

#### 3.2.5 開発者向けツール画面（隠し機能）

```
┌─────────────────────────────────┐
│      開発者向けツール           │
├─────────────────────────────────┤
│  同期ログ                       │
│  ┌─────────────────────────┐   │
│  │ incremental              │   │
│  │ 📅 abc123de  12/23 10:30│   │
│  │ ↑5 ↓2 ⊘1    410↻       │   │
│  ├─────────────────────────┤   │
│  │ full                     │   │
│  │ 📅 abc123de  12/23 09:15│   │
│  │ ↑50 ↓10 ⊘0             │   │
│  └─────────────────────────┘   │
├─────────────────────────────────┤
│  操作                           │
│  ┌─────────────────────────┐   │
│  │ [直近100件をコピー(JSON)]│   │
│  │ [ログを全削除]           │   │
│  └─────────────────────────┘   │
├─────────────────────────────────┤
│  統計                           │
│  ┌─────────────────────────┐   │
│  │ ログ総数: 245           │   │
│  └─────────────────────────┘   │
└─────────────────────────────────┘
```

**アクセス方法**:
- 設定画面のバージョン情報を7回タップ
- 開発者モードが有効化され、設定画面に「開発者向けツール」セクションが表示される

**機能**:
- **同期ログ一覧**: 全ての同期操作のログを新しい順に表示
  - syncType（同期種別）、日時、カレンダーIDハッシュ、結果カウント
  - エラー、410フォールバック、429リトライのインジケーター
- **ログ詳細**: ログをタップで詳細モーダル表示
  - 基本情報（同期種別、開始/終了時刻、所要時間、カレンダーIDハッシュ）
  - 結果（更新/削除/スキップ/競合カウント、HTTPステータスコード）
  - フラグ（410フォールバック、429リトライ）
  - エラー情報（エラー種別、メッセージ）
- **JSON出力**: ログをクリップボードにコピー（デバッグ用）
- **ログ削除**: 全てのログを削除（確認ダイアログあり）

**プライバシー保護**:
- ユーザーコンテンツ（タイトル、本文）は記録しない
- カレンダーIDはSHA256ハッシュの最初の8文字のみ保存
- 同期操作のメタデータのみ記録

---

## 3.5 キャッシュとデータ寿命

### 3.5.1 短期キャッシュ（CachedCalendarEvent）

**目的**: Timeline描画用の高速アクセス

**範囲**: 同期対象期間内（デフォルト: 過去30日〜未来30日）

**管理**:
- `CalendarSyncService`が差分同期で更新
- `CalendarCacheCleaner`が同期範囲外のデータを定期的に削除
- カレンダーごとに`syncToken`を保持（`CalendarSyncState`）

**データ構造**:
- `uid`: `"calendarId:eventId"`形式のユニークID
- `linkedJournalId`: `extendedProperties.private.journalId`から取得
- `status`: `"confirmed"` / `"cancelled"` など

### 3.5.2 長期キャッシュ（ArchivedCalendarEvent）

**目的**: 振り返り・検索用の全期間データ

**範囲**: 2000年1月1日〜未来1年

**管理**:
- `ArchiveSyncService`が設定画面から明示的に取り込み
- 半年単位でAPI取得（`splitIntoHalfYearRanges`）
- レート制限対策として各バッチ間に0.2秒のsleep挿入
- **レート制限対応**: 指数バックオフ + ジッター（HTTP 429/403 rateLimitExceeded時に自動リトライ）
- 進捗表示あり（`Progress`構造体）
- **キャンセル機能**: 取り込み中にキャンセル可能（`Task.checkCancellation()`を使用）
- **進捗保存**: UserDefaultsに進捗を保存し、再開時に続きから実行

**データ構造**:
- `uid`: `"calendarId:eventId"`形式のユニークID
- `startDayKey`: `YYYYMMDD`形式の日付インデックス（検索高速化用）
- `linkedJournalId`: `extendedProperties.private.journalId`から取得

**注意**: 長期キャッシュの取り込みは時間がかかるため、ユーザーに明示的に操作させる必要がある。

---

## 4. データモデル

### 4.1 JournalEntry（SwiftData）

**実装準拠のモデル定義**:

```swift
@Model
final class JournalEntry {
    @Attribute(.unique) var id: UUID
    var journalId: UUID  // extendedProperties.private.journalId に保存される値
    
    var title: String?
    var body: String  // Google Calendar の description に保存
    
    var eventDate: Date  // 出来事の日時（作成日時とは別）
    var createdAt: Date
    var updatedAt: Date
    
    var colorHex: String  // UI用カラー（HEX形式）
    var iconName: String  // UI用アイコン名
    
    // Google Calendar 連携用
    var linkedCalendarId: String?  // 書き込んだカレンダーID（例: "primary"）
    var linkedEventId: String?  // Google側のeventId
    var linkedEventUpdatedAt: Date?  // カレンダー側のupdated（競合判定用）
    var needsCalendarSync: Bool  // 同期失敗したらtrue（再送用）

    // 競合解決用
    var hasConflict: Bool = false  // 競合状態フラグ
    var conflictDetectedAt: Date?  // 競合検知日時
    var conflictRemoteTitle: String?  // カレンダー版のタイトル（スナップショット）
    var conflictRemoteBody: String?  // カレンダー版の本文（スナップショット）
    var conflictRemoteUpdatedAt: Date?  // カレンダー版のupdated
    var conflictRemoteEventDate: Date?  // カレンダー版のイベント日時
}
```

**タグの扱い**
- タグは独立したデータ構造として持たない
- 本文（`body`）から`#tag`形式をパース（`TagExtractor`）
- Google Calendarの`description`には本文そのままを保存（タグは本文内に含まれる）
- 全期間のタグ一覧は作成しない
- 最近使われたタグのみ表示（同期対象期間内での使用頻度・直近使用日時、`TagStats`）

**Google Calendar連携**
- `extendedProperties.private`に`journalId`を保存（UUID文字列）
- `description`に`body`をそのまま保存
- `summary`（タイトル）は`title`が空なら`"ジャーナル"`を設定

### 4.2 Location

```swift
struct Location: Codable {
    var name: String?
    var address: String?
    var latitude: Double?
    var longitude: Double?
}
```

### 4.3 PhotoData

```swift
@Model
class PhotoData {
    var id: UUID
    var imageData: Data
    var createdAt: Date
}
```

### 4.4 CachedCalendarEvent（SwiftData）

**短期キャッシュ用モデル**:

```swift
@Model
final class CachedCalendarEvent {
    @Attribute(.unique) var uid: String  // "calendarId:eventId"
    var calendarId: String
    var eventId: String
    var linkedJournalId: String?  // extendedProperties.private.journalId
    
    var title: String
    var desc: String?
    var start: Date
    var end: Date?
    var isAllDay: Bool
    var status: String  // "confirmed" / "cancelled"
    
    var updatedAt: Date  // APIのupdated
    var cachedAt: Date  // 端末に保存した時刻
}
```

### 4.5 ArchivedCalendarEvent（SwiftData）

**長期キャッシュ用モデル**:

```swift
@Model
final class ArchivedCalendarEvent {
    @Attribute(.unique) var uid: String  // "calendarId:eventId"
    var calendarId: String
    var eventId: String
    
    var title: String
    var desc: String?
    var start: Date
    var end: Date?
    var isAllDay: Bool
    var status: String
    
    var updatedAt: Date
    var startDayKey: Int  // YYYYMMDD形式（検索高速化用）
    var linkedJournalId: String?
    var cachedAt: Date
}
```

### 4.6 GoogleCalendarEvent（APIレスポンス）

**APIクライアント内部で使用するドメインモデル**:

```swift
struct GoogleCalendarEvent {
    var id: String
    var title: String
    var description: String?
    var start: Date
    var end: Date?
    var isAllDay: Bool
    var status: String  // "confirmed" / "cancelled"
    var updated: Date
    var privateProps: [String: String]?  // extendedProperties.private
}
```

### 4.7 CachedCalendar（SwiftData）

**カレンダーメタデータ**:

```swift
@Model
final class CachedCalendar {
    @Attribute(.unique) var calendarId: String
    var summary: String
    var isEnabled: Bool  // 表示ON/OFF
    var colorHex: String?  // カラーパレットID
    var iconName: String?  // アイコンパレットID
}
```

### 4.8 AppSettings（UserDefaults）

```swift
struct AppSettings {
    var useCurrentLocationByDefault: Bool  // 位置情報デフォルト設定
    var selectedCalendarIds: [String]      // 表示するカレンダー
    var calendarColorMap: [String: String]  // カレンダーID → カラーパレットIDのマッピング
    var calendarIconMap: [String: String]   // カレンダーID → アイコンパレットIDのマッピング
    var theme: AppTheme                    // ライト/ダーク/システム
}
```

### 4.9 SyncLog（SwiftData）

**開発者向け同期ログモデル**:

```swift
@Model
final class SyncLog {
    @Attribute(.unique) var id: UUID
    var timestamp: Date  // 同期開始時刻
    var endTimestamp: Date?  // 同期終了時刻
    var syncType: String  // 同期種別: "incremental", "full", "archive", "journal_push", "calendar_list"
    var calendarIdHash: String?  // カレンダーIDのSHA256ハッシュ（最初の8文字）
    var httpStatusCode: Int?
    var updatedCount: Int
    var deletedCount: Int
    var skippedCount: Int
    var conflictCount: Int
    var had410Fallback: Bool  // syncToken期限切れでフルバックした
    var had429Retry: Bool  // レート制限でリトライした
    var retryCount: Int  // リトライ回数（429エラー時）
    var totalWaitTime: Double  // 合計待機時間（秒）
    var errorType: String?  // エラー種別
    var errorMessage: String?  // エラーメッセージ
}
```

**同期種別（syncType）**:
- `"incremental"`: 差分同期（syncToken使用）
- `"full"`: フル同期（syncToken期限切れ時）
- `"archive"`: 長期キャッシュ取り込み
- `"journal_push"`: ジャーナル→カレンダー同期
- `"calendar_list"`: カレンダーリスト取得

**プライバシー保護**:
- カレンダーIDは`SHA256.hash`で暗号化し、最初の8文字のみ保存
- ユーザーコンテンツ（タイトル、本文）は記録しない
- 同期操作のメタデータのみ記録

**JSON出力**:
- `toJSON()`メソッドで辞書形式に変換
- ISO8601形式で日時を出力
- デバッグ用にクリップボードコピー可能

---

## 5. 技術スタック

| レイヤー | 技術 |
|----------|------|
| 言語 | Swift 5.9+ |
| UIフレームワーク | SwiftUI |
| データ永続化 | SwiftData |
| 認証 | Google Sign-In SDK |
| カレンダーAPI | Google Calendar API (REST) |
| 位置情報 | CoreLocation |
| 写真 | PhotosUI (PhotosPicker) |
| キャッシュ管理 | SwiftData（CachedCalendarEvent / ArchivedCalendarEvent） |

---

## 6. 開発フェーズ（実装状況）

### Phase 1: MVP ✅ 完了
**目標**: 基本的なジャーナル機能が動作する

- [x] プロジェクトセットアップ
- [x] SwiftDataモデル定義
- [x] メイン画面（タイムライン表示）
- [x] ジャーナル作成/編集画面
- [ ] カレンダーシート（日付選択、記録日ドット表示） - **未実装**
- [x] 基本的な検索機能
- [x] ハッシュタグ抽出（本文から `#tag` をパース）
- [x] 手入力検索（`#tag` 形式でタグ検索）
- [x] 最近使ったタグのローカル表示（`TagStats`）
- [x] 設定画面（基本項目）

### Phase 2: Googleカレンダー連携 ✅ 完了
**目標**: カレンダーの予定を表示できる

- [x] Google Sign-In実装（`GoogleAuthService`）
- [x] Calendar API連携（`GoogleCalendarClient`）
- [x] 予定の取得・表示（同期範囲: 過去30日〜未来30日、設定可能）
- [x] 差分同期の実装（`syncToken`使用、`CalendarSyncService`）
- [x] 予定とジャーナルの統合タイムライン（`TimelineItem`）
- [x] 同期範囲内イベントからのタグ抽出（`TagExtractor`）
- [x] Google Calendar への保存（`JournalCalendarSyncService`、`extendedProperties.private`使用）
- [x] 双方向同期（`CalendarToJournalSyncService`）
- [x] 長期キャッシュ取り込み（`ArchiveSyncService`）

### Phase 3: 拡張機能 🔄 一部実装済み
**目標**: 使いやすさ向上

- [x] カラー・アイコン選択機能（カラーパレット・アイコンパレット実装）
- [ ] 場所情報の追加（デフォルト設定含む） - **未実装**
- [ ] **過去の同じ日を振り返り機能** - **未実装**

### Phase 4: 公開準備 🔄 進行中
**目標**: App Store申請

- [ ] アプリアイコン・スクリーンショット
- [ ] プライバシーポリシー作成
- [ ] App Store Connect設定
- [ ] TestFlight配布
- [ ] 審査申請

### Phase 5: 開発者向けツール ✅ 完了
**目標**: デバッグと問題解決の効率化

- [x] 競合検知UI（`ConflictResolutionView`）
- [x] 競合解決機能（useLocal/useRemote）
- [x] 長期キャッシュ取り込みのキャンセル機能
- [x] 開発者向けツール画面（`DeveloperToolsView`）
- [x] 同期ログ記録（`SyncLog`モデル）
- [x] 隠し開発者モード（7回タップで有効化）

### Phase 6: 将来の拡張（公開後）
- [ ] ウィジェット対応
- [ ] カレンダーシート（日付選択、記録日ドット表示）
- [ ] 過去の同じ日を振り返り機能
- [ ] ダークモード対応
- [ ] iPad対応
- [ ] 場所情報の追加（デフォルト設定含む）

**注意**: CloudKit同期は**実装予定なし**。Google Calendarが唯一の外部永続先である。

---

## 6.5 設計上の思想

### 6.5.1 基本方針
- タグは管理するものではなく「思考の痕跡」
- 完全性よりも即時性・軽さを優先
- **Google Calendar を唯一の真実のソース（Single Source of Truth）とする**
- **アプリ内のSwiftDataはキャッシュおよび編集補助にすぎない**
- **サーバー同期やクラウド保存を「将来やるかも」前提で書かない** → Firebase は Auth / Crashlytics 専用で確定
- **「双方向同期」は抽象概念ではなく、`journalId` + `extendedProperties.private` による実装依存仕様である**

### 6.5.2 タグ設計の思想
- タグは本文中に自然に記述されるもの
- 全期間のタグ網羅は行わない（必要になった場合のみ、将来的に同期期間拡張や段階的インデックス構築を検討）
- 最近使ったタグのみを表示することで、UIをシンプルに保つ

---

## 7. UI/UXガイドライン

### 7.1 デザイン原則（変更なし）

- **シンプル**: 2タブ構成、必要最小限の要素
- **モダン**: iOS標準に準拠しつつ洗練されたデザイン
- **高速**: 入力から保存まで最短ステップ
- **文章が主役で、UIは邪魔をしないこと**

---

### 7.2 カラースキーマ（更新）

本アプリは **初期リリースではライトモードのみをサポート** する。
**ダークモード対応は未実装**（将来フェーズで検討予定）。

#### 7.2.1 ベースカラー（ライトモード）

| 要素 | カラーコード | 備考 |
|------|-------------|------|
| 背景 | #FAFAFA | 純白を避け、長文閲覧時の疲労を軽減 |
| メインテキスト | #1F1F1F | 高コントラスト |
| サブテキスト | rgba(31,31,31,0.6) | 補足情報用 |
| セパレーター | rgba(0,0,0,0.08) | 目立たせない |

---

#### 7.2.2 カードの基本デザイン

**予定とジャーナルは完全に統一されたカードデザインを使用する**（視覚的な区別は行わない）。

カードの背景色とアイコンは、ユーザーがパレットから選択したものを適用する。

- ジャーナルエントリ作成時: カラーパレットから選択可能
  - カラー: デフォルト: ミュートブルー #E3F2FD
  - アイコン: カレンダーごとに設定したアイコンを適用（設定画面で設定）
- 予定表示時: 設定でカレンダーごとに選択したカラーとアイコンを適用
  - カラー: デフォルト: ミュートブルー #E3F2FD
  - アイコン: デフォルト: 📅

---

#### 7.2.3 アクセントカラー

| 要素 | カラーコード |
|------|-------------|
| アクセント | #4CAF50 |

使用箇所は以下に限定する。

- 新規作成ボタン（FAB）
- 選択中の日付
- トグルON状態
- リンク的テキスト

---

### 7.3 カレンダー別カラー設定（新規追加）

#### 7.3.1 概要

Googleカレンダーごとに、ユーザーが表示色を選択できる機能を提供する。
色はアプリ側で用意した **デフォルトカラーパレットから選択** する方式とする。

自由入力型のカラーピッカーは提供しない。

---

#### 7.3.2 デフォルトカラーパレット（ライトモード）

| 名称 | カラーコード | 想定用途 |
|------|-------------|---------|
| ミュートブルー | #E3F2FD | 仕事 / 共通 |
| ミュートグリーン | #E8F5E9 | 健康 / 習慣 |
| セージ | #EEF3F1 | 家族 / 私用 |
| サンドベージュ | #F5F1EC | 生活 / 雑多 |
| ミュートオレンジ | #FBE9E7 | 外出 / イベント |
| ダスティーレッド | #F3E5E5 | 期限 / 重要 |
| ラベンダーグレー | #F1EEF6 | 学習 / 趣味 |
| スレートグレー | #ECEFF1 | 色を付けたくない場合 |

---

#### 7.3.3 タイムラインでのカラーとアイコンの扱い

- カレンダー色はカードの背景色として適用する
- **カレンダーアイコンはカードのアイコンとして適用する**（カレンダーごとに設定画面で選択）
- ジャーナルエントリのカラーは個別に選択可能（カラーパレットから選択）
- ジャーナルエントリのアイコンは、そのエントリが属するカレンダーに設定されたアイコンを適用
- 予定のカラーとアイコンは、設定でカレンダーごとに選択したものを適用
- 同一色・同一アイコンを複数カレンダーで選択可能とする
- **予定とジャーナルは視覚的に区別しない**（完全に統一されたカードデザイン）

---

#### 7.3.4 アイコンパレット

カレンダーごとに設定するアイコンは、以下のアイコンパレットから選択する。設定したアイコンは、そのカレンダーに属する予定やジャーナルエントリのカードに表示される。

| アイコン | 名称 | 想定用途 |
|---------|------|---------|
| 📝 | メモ | 一般的な記録 |
| 📅 | カレンダー | 予定・イベント |
| 💡 | アイデア | 思いつき・発想 |
| 🎯 | 目標 | 目標・タスク |
| ❤️ | 感情 | 感情・思い出 |
| 🍽️ | 食事 | 食事・料理 |
| 🏃 | 運動 | 運動・健康 |
| 📚 | 学習 | 勉強・読書 |
| 🎨 | 創作 | 創作活動 |
| 🎵 | 音楽 | 音楽・エンタメ |
| 🚗 | 移動 | 旅行・移動 |
| 💼 | 仕事 | 仕事・ビジネス |
| 🏠 | 家 | 家庭・プライベート |
| 🌟 | 星 | 特別な日 |
| （なし） | なし | アイコンを表示しない |

---

### 7.4 カレンダー画面の配色ルール（補足）

- ジャーナルあり日付: アクセントカラーのドット
- 今日の日付: アクセントカラーで塗りつぶし
- 選択中の日付: アクセントカラーの枠線
- それ以外の日付: グレー系テキスト

---

### 7.5 タイポグラフィ

#### 7.5.1 フォント設定

| 言語 | フォント | 用途 |
|------|---------|------|
| 日本語 | Noto Sans JP | すべての日本語テキスト |
| 英数字 | Inter | すべての英数字テキスト |

#### 7.5.2 フォントサイズ

- タイトル: 18pt（セミボールド）
- 本文: 16pt（レギュラー）
- サブテキスト（日時、場所など）: 14pt（レギュラー）
- キャプション: 12pt（レギュラー）

---

## 8. 非機能要件

### 8.1 パフォーマンス
- アプリ起動: 2秒以内
- ジャーナル保存: 即座
- カレンダー読み込み: 3秒以内
- 過去の同じ日検索: 1秒以内
- タイムラインスクロール: 60fps維持

### 8.2 セキュリティ
- Google認証トークンはKeychainに保存
- ローカルデータは端末内に保存（Phase 1）

### 8.3 プライバシー
- 位置情報は許可制
- 写真アクセスは許可制
- 分析データは収集しない（Phase 1）

---

## 9. 制約・前提条件

### 9.1 技術的制約

- iOS 17以上必須（SwiftData使用のため）
- Googleアカウント必須（カレンダー連携時）
- ネットワーク必須（カレンダー同期時）
- オフライン時はジャーナル機能のみ利用可（ローカルキャッシュの表示・編集）

### 9.2 設計上の制約

- **CloudKit同期は実装しない**: Google Calendarが唯一の外部永続先である
- **サーバー同期は実装しない**: 双方向同期はGoogle Calendar API経由で直接実現
- **ダークモードは未実装**: 初期リリースではライトモードのみサポート

### 9.3 同期に関する制約

- 同期レート制限: 5秒間隔（`SyncRateLimiter`）
- 同期範囲: デフォルト過去30日〜未来30日（設定可能、最大365日）
- `syncToken`の有効期限: Google Calendar APIの仕様に依存（期限切れ時はフル同期にフォールバック）
- 競合処理: 30秒以上の差がある場合に競合検知、ユーザーに解決UIを表示（`ConflictResolutionView`）

---

## 10. 用語集

| 用語 | 説明 |
|------|------|
| エントリ | 1つのジャーナル記録（`JournalEntry`） |
| タイムライン | 逆時系列で並んだエントリと予定の一覧 |
| タグ | ハッシュタグ形式のラベル（#仕事、#アイデア等） |
| 過去の同じ日 | 今日と同じ月日の過去年のエントリ |
| 短期キャッシュ | `CachedCalendarEvent`。同期対象期間内のイベントを保持 |
| 長期キャッシュ | `ArchivedCalendarEvent`。全期間のイベントを保持（振り返り用） |
| syncToken | Google Calendar APIの差分同期用トークン |
| extendedProperties.private | Google Calendar Eventの拡張プロパティ。`journalId`を保存 |
| Single Source of Truth | Google Calendarが唯一の真実のソースである設計原則 |

