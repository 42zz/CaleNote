name: CI

on:
  pull_request:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    runs-on: macos-15
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install SwiftLint
        run: brew install swiftlint
      - name: Run SwiftLint
        run: swiftlint --config .swiftlint.yml --reporter github-actions-logging

  unit_tests:
    if: github.event_name == 'pull_request'
    runs-on: macos-15
    outputs:
      coverage: ${{ steps.coverage.outputs.percent }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Show Xcode version
        run: xcodebuild -version
      - name: Select simulator
        run: |
          python - <<'PY'
          import json
          import os
          import re
          import subprocess
          import sys

          data = subprocess.check_output(
              ["xcrun", "simctl", "list", "-j", "devices", "runtimes"]
          )
          info = json.loads(data)
          runtimes = [
              r for r in info.get("runtimes", [])
              if r.get("isAvailable") and r.get("name", "").startswith("iOS")
          ]
          if not runtimes:
              print("No iOS runtimes available.", file=sys.stderr)
              sys.exit(1)

          def version_tuple(runtime):
              version = runtime.get("version") or runtime.get("name", "").split(" ", 1)[-1]
              return [int(part) for part in re.findall(r"\d+", version)]

          runtimes.sort(key=version_tuple)
          runtime = runtimes[-1]
          runtime_id = runtime["identifier"]
          devices = [
              d for d in info.get("devices", {}).get(runtime_id, [])
              if d.get("isAvailable")
          ]
          iphones = [d for d in devices if d.get("name", "").startswith("iPhone")]
          if not iphones:
              print(f"No iPhone simulators for runtime {runtime_id}.", file=sys.stderr)
              print("Available devices:", devices, file=sys.stderr)
              sys.exit(1)

          device = iphones[0]["name"]
          os_version = runtime.get("version") or runtime.get("name", "").split(" ", 1)[-1]
          print(f"Selected iOS runtime: {runtime.get('name')} ({os_version})", file=sys.stderr)
          print(f"Selected simulator: {device}", file=sys.stderr)

          env_path = os.environ["GITHUB_ENV"]
          with open(env_path, "a", encoding="utf-8") as env_file:
              env_file.write(f"SIM_DEVICE={device}\n")
              env_file.write(f"SIM_OS={os_version}\n")
              env_file.write(
                  f"DESTINATION=platform=iOS Simulator,OS={os_version},name={device}\n"
              )
          PY
      - name: Boot simulator
        run: |
          xcrun simctl boot "$SIM_DEVICE" || true
          xcrun simctl bootstatus "$SIM_DEVICE" -b
      - name: Run unit tests
        run: |
          set -o pipefail
          xcodebuild \
            -scheme CaleNote \
            -destination "$DESTINATION" \
            -only-testing:CaleNoteTests \
            -enableCodeCoverage YES \
            -resultBundlePath TestResults.xcresult \
            CODE_SIGNING_ALLOWED=NO \
            test | tee test.log
      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: TestResults.xcresult
      - name: Compute coverage
        id: coverage
        run: |
          python - <<'PY'
          import json, subprocess, sys
          data = subprocess.check_output([
              'xcrun', 'xccov', 'view', '--report', '--json', 'TestResults.xcresult'
          ])
          report = json.loads(data)
          coverage = report.get('lineCoverage', 0) * 100
          print(f"Coverage: {coverage:.2f}%")
          with open('coverage.txt', 'w', encoding='utf-8') as f:
              f.write(f"{coverage:.2f}")
          with open('$GITHUB_OUTPUT', 'a', encoding='utf-8') as f:
              f.write(f"percent={coverage:.2f}\n")
          PY
      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: coverage.txt

  ui_tests:
    if: github.event_name == 'pull_request'
    runs-on: macos-15
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Show Xcode version
        run: xcodebuild -version
      - name: Select simulator
        run: |
          python - <<'PY'
          import json
          import os
          import re
          import subprocess
          import sys

          data = subprocess.check_output(
              ["xcrun", "simctl", "list", "-j", "devices", "runtimes"]
          )
          info = json.loads(data)
          runtimes = [
              r for r in info.get("runtimes", [])
              if r.get("isAvailable") and r.get("name", "").startswith("iOS")
          ]
          if not runtimes:
              print("No iOS runtimes available.", file=sys.stderr)
              sys.exit(1)

          def version_tuple(runtime):
              version = runtime.get("version") or runtime.get("name", "").split(" ", 1)[-1]
              return [int(part) for part in re.findall(r"\d+", version)]

          runtimes.sort(key=version_tuple)
          runtime = runtimes[-1]
          runtime_id = runtime["identifier"]
          devices = [
              d for d in info.get("devices", {}).get(runtime_id, [])
              if d.get("isAvailable")
          ]
          iphones = [d for d in devices if d.get("name", "").startswith("iPhone")]
          if not iphones:
              print(f"No iPhone simulators for runtime {runtime_id}.", file=sys.stderr)
              print("Available devices:", devices, file=sys.stderr)
              sys.exit(1)

          device = iphones[0]["name"]
          os_version = runtime.get("version") or runtime.get("name", "").split(" ", 1)[-1]
          print(f"Selected iOS runtime: {runtime.get('name')} ({os_version})", file=sys.stderr)
          print(f"Selected simulator: {device}", file=sys.stderr)

          env_path = os.environ["GITHUB_ENV"]
          with open(env_path, "a", encoding="utf-8") as env_file:
              env_file.write(f"SIM_DEVICE={device}\n")
              env_file.write(f"SIM_OS={os_version}\n")
              env_file.write(
                  f"DESTINATION=platform=iOS Simulator,OS={os_version},name={device}\n"
              )
          PY
      - name: Boot simulator
        run: |
          xcrun simctl boot "$SIM_DEVICE" || true
          xcrun simctl bootstatus "$SIM_DEVICE" -b
      - name: Run UI tests
        run: |
          set -o pipefail
          xcodebuild \
            -scheme CaleNote \
            -destination "$DESTINATION" \
            -only-testing:CaleNoteUITests \
            -resultBundlePath UITestResults.xcresult \
            CODE_SIGNING_ALLOWED=NO \
            test | tee ui-test.log
      - name: Upload UI test results
        uses: actions/upload-artifact@v4
        with:
          name: ui-test-results
          path: UITestResults.xcresult

  pr_summary:
    if: always() && github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    needs: [lint, unit_tests, ui_tests]
    steps:
      - name: Create or update PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const marker = '<!-- calenote-ci-summary -->';
            const coverage = '${{ needs.unit_tests.outputs.coverage }}';
            const lint = '${{ needs.lint.result }}';
            const unit = '${{ needs.unit_tests.result }}';
            const ui = '${{ needs.ui_tests.result }}';
            const body = `${marker}\n### CI Summary\n- SwiftLint: **${lint}**\n- Unit Tests: **${unit}**\n- UI Tests: **${ui}**\n- Coverage: **${coverage}%**\n`;

            const { owner, repo } = context.repo;
            const issue_number = context.issue.number;
            const comments = await github.paginate(github.rest.issues.listComments, {
              owner,
              repo,
              issue_number,
            });
            const existing = comments.find(c => c.body && c.body.includes(marker));
            if (existing) {
              await github.rest.issues.updateComment({ owner, repo, comment_id: existing.id, body });
            } else {
              await github.rest.issues.createComment({ owner, repo, issue_number, body });
            }

  full_tests:
    if: github.event_name == 'push'
    runs-on: macos-15
    outputs:
      coverage: ${{ steps.coverage.outputs.percent }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Show Xcode version
        run: xcodebuild -version
      - name: Select simulator
        run: |
          python - <<'PY'
          import json
          import os
          import re
          import subprocess
          import sys

          data = subprocess.check_output(
              ["xcrun", "simctl", "list", "-j", "devices", "runtimes"]
          )
          info = json.loads(data)
          runtimes = [
              r for r in info.get("runtimes", [])
              if r.get("isAvailable") and r.get("name", "").startswith("iOS")
          ]
          if not runtimes:
              print("No iOS runtimes available.", file=sys.stderr)
              sys.exit(1)

          def version_tuple(runtime):
              version = runtime.get("version") or runtime.get("name", "").split(" ", 1)[-1]
              return [int(part) for part in re.findall(r"\d+", version)]

          runtimes.sort(key=version_tuple)
          runtime = runtimes[-1]
          runtime_id = runtime["identifier"]
          devices = [
              d for d in info.get("devices", {}).get(runtime_id, [])
              if d.get("isAvailable")
          ]
          iphones = [d for d in devices if d.get("name", "").startswith("iPhone")]
          if not iphones:
              print(f"No iPhone simulators for runtime {runtime_id}.", file=sys.stderr)
              print("Available devices:", devices, file=sys.stderr)
              sys.exit(1)

          device = iphones[0]["name"]
          os_version = runtime.get("version") or runtime.get("name", "").split(" ", 1)[-1]
          print(f"Selected iOS runtime: {runtime.get('name')} ({os_version})", file=sys.stderr)
          print(f"Selected simulator: {device}", file=sys.stderr)

          env_path = os.environ["GITHUB_ENV"]
          with open(env_path, "a", encoding="utf-8") as env_file:
              env_file.write(f"SIM_DEVICE={device}\n")
              env_file.write(f"SIM_OS={os_version}\n")
              env_file.write(
                  f"DESTINATION=platform=iOS Simulator,OS={os_version},name={device}\n"
              )
          PY
      - name: Boot simulator
        run: |
          xcrun simctl boot "$SIM_DEVICE" || true
          xcrun simctl bootstatus "$SIM_DEVICE" -b
      - name: Run full test suite
        run: |
          set -o pipefail
          xcodebuild \
            -scheme CaleNote \
            -destination "$DESTINATION" \
            -enableCodeCoverage YES \
            -resultBundlePath FullTestResults.xcresult \
            CODE_SIGNING_ALLOWED=NO \
            test | tee full-test.log
      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: full-test-results
          path: FullTestResults.xcresult
      - name: Compute coverage
        id: coverage
        run: |
          python - <<'PY'
          import json, subprocess
          data = subprocess.check_output([
              'xcrun', 'xccov', 'view', '--report', '--json', 'FullTestResults.xcresult'
          ])
          report = json.loads(data)
          coverage = report.get('lineCoverage', 0) * 100
          print(f"Coverage: {coverage:.2f}%")
          with open('coverage.txt', 'w', encoding='utf-8') as f:
              f.write(f"{coverage:.2f}")
          with open('$GITHUB_OUTPUT', 'a', encoding='utf-8') as f:
              f.write(f"percent={coverage:.2f}\n")
          PY
      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: coverage.txt

  build:
    if: github.event_name == 'push'
    runs-on: macos-15
    strategy:
      matrix:
        configuration:
          - Debug
          - Release
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Show Xcode version
        run: xcodebuild -version
      - name: Select simulators
        run: |
          python - <<'PY'
          import json
          import os
          import re
          import subprocess
          import sys

          data = subprocess.check_output(
              ["xcrun", "simctl", "list", "-j", "devices", "runtimes"]
          )
          info = json.loads(data)
          runtimes = [
              r for r in info.get("runtimes", [])
              if r.get("isAvailable") and r.get("name", "").startswith("iOS")
          ]
          if not runtimes:
              print("No iOS runtimes available.", file=sys.stderr)
              sys.exit(1)

          def version_tuple(runtime):
              version = runtime.get("version") or runtime.get("name", "").split(" ", 1)[-1]
              return [int(part) for part in re.findall(r"\d+", version)]

          runtimes.sort(key=version_tuple)
          runtime = runtimes[-1]
          runtime_id = runtime["identifier"]
          devices = [
              d for d in info.get("devices", {}).get(runtime_id, [])
              if d.get("isAvailable")
          ]
          iphones = [d for d in devices if d.get("name", "").startswith("iPhone")]
          if not iphones:
              print(f"No iPhone simulators for runtime {runtime_id}.", file=sys.stderr)
              print("Available devices:", devices, file=sys.stderr)
              sys.exit(1)

          os_version = runtime.get("version") or runtime.get("name", "").split(" ", 1)[-1]
          selected = iphones[:2]
          print(f"Selected iOS runtime: {runtime.get('name')} ({os_version})", file=sys.stderr)
          print(f"Selected simulators: {[d['name'] for d in selected]}", file=sys.stderr)

          env_path = os.environ["GITHUB_ENV"]
          with open(env_path, "a", encoding="utf-8") as env_file:
              env_file.write(f"SIM_OS={os_version}\n")
              env_file.write(f"SIM_DEVICE_1={selected[0]['name']}\n")
              if len(selected) > 1 and selected[1]["name"] != selected[0]["name"]:
                  env_file.write(f"SIM_DEVICE_2={selected[1]['name']}\n")
          PY
      - name: Build (${{ matrix.configuration }})
        run: |
          set -o pipefail
          for device in "$SIM_DEVICE_1" "$SIM_DEVICE_2"; do
            if [ -z "$device" ]; then
              continue
            fi
            xcodebuild \
              -scheme CaleNote \
              -configuration ${{ matrix.configuration }} \
              -destination "platform=iOS Simulator,OS=$SIM_OS,name=$device" \
              -derivedDataPath DerivedData \
              CODE_SIGNING_ALLOWED=NO \
              build | tee -a build.log
          done
      - name: Check build warnings
        run: |
          warnings=$(grep -E "warning:|warning:" -c build.log || true)
          echo "Warnings: $warnings"
          if [ "$warnings" -gt 0 ]; then
            echo "Build has warnings."
            exit 1
          fi
      - name: Upload dSYM
        if: matrix.configuration == 'Release'
        uses: actions/upload-artifact@v4
        with:
          name: dsym-${{ matrix.destination }}
          path: DerivedData/**/dSYMs

  coverage_badge:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    needs: [full_tests]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Ensure badge directory
        run: mkdir -p .github/badges
      - name: Create badge
        uses: emibcn/badge-action@v2
        with:
          label: coverage
          status: ${{ needs.full_tests.outputs.coverage }}%
          color: green
          path: .github/badges/coverage.svg
      - name: Commit badge
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'chore(ci): update coverage badge'
          file_pattern: .github/badges/coverage.svg
