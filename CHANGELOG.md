# CaleNote 変更履歴

このファイルはCaleNoteの仕様変更と実装の履歴を記録します。

## [0.25] - 2025-12-24

### 変更内容
- エントリー詳細画面のナビゲーションタイトルに日時情報を表示するように変更
- ナビゲーションタイトルの日時表示レイアウトを改善（日付の下に時間を配置）

### 追加
- `NavigationDateTimeView`コンポーネントを追加（ナビゲーションタイトル用のコンパクトな日時表示）
- 各詳細画面（`JournalDetailView`、`CalendarEventDetailView`、`ArchivedCalendarEventDetailView`）のナビゲーションバーに日時情報を表示

### 修正
- 時間指定イベントのナビゲーションタイトル表示で、日付を1行目、時間を2行目に配置するように変更

---

## [0.24] - 2025-12-24

### 変更内容
- **タイムライン表示仕様を短期キャッシュのみに変更**
- タイムライン通常表示から長期キャッシュ（ArchivedCalendarEvent）を完全に除外
- 短期キャッシュ（CachedCalendarEvent）+ JournalEntry のみを表示対象に変更
- 長期キャッシュは検索・振り返り専用として位置付けを明確化

### 削除
- `TimelinePagingState`を使用した ArchivedCalendarEvent のページネーション機能を削除
- `loadPastPageIfNeeded`、`loadFuturePageIfNeeded`を削除
- `pagingState`、`hasInitialLoadCompleted`、`recentlyReturnedFromDetail`などの状態変数を削除
- 長期キャッシュ混在による重複・順序不整合・レイアウトシフトの問題を根本解決

### 修正
- タイムライン一覧で終日イベントの表示を改善
- `TimelineItem`に`isAllDay`プロパティを追加
- `TimelineRowView`で終日イベントの判定ロジックを追加

---

## [0.23] - 2025-12-24

### 変更内容
- エントリー詳細画面のメタ情報表示を改善
- 3つの詳細画面（`JournalDetailView`、`CalendarEventDetailView`、`ArchivedCalendarEventDetailView`）のコンポーネントを統合

### 修正
- `DetailViewUtilities.swift`に`formatSyncDateTime`関数を追加（YYYY/MM/DD HH:mm形式）
- `DetailMetadataSection`に`AdditionalMetadataItem`構造体と`additionalMetadata`パラメータを追加
- コードの重複を削減し、UIの一貫性を向上

---

## [0.22] - 2025-12-24

### 変更内容
- 関連エントリー一覧の表示仕様を改善

### 修正
- `RelatedMemoriesSection.swift`の年表示でカンマ区切りが入る問題を修正
- 年ヘッダーに相対年情報（「○年前」）を追加して時間の重みを強調
- 関連エントリー行に日付情報を明示的に表示して可読性を向上

---

## [0.21] - 2024-12-24

### 追加機能
- エントリー作成時にカレンダー側に登録するエントリーの時間を設定画面で指定できる機能を追加（デフォルト30分）

### 変更内容
- `JournalWriteSettings`にエントリー時間（分）の保存・読み込み機能を追加
- `SettingsView`に「エントリー設定」セクションを追加し、エントリー時間を1〜480分（5分刻み）で設定可能に
- `JournalCalendarSyncService`で設定値を読み込んで使用するように変更（60分のハードコードを削除）
- デフォルトの書き込み先カレンダー設定を、カレンダー詳細画面（`CalendarSettingsView`）から設定画面の「エントリー設定」セクション（`SettingsView`）に移動
- `CalendarSettingsView`から「書き込み先」セクションを削除

---

## [0.20] - 2025-12-23

### 追加機能
- タイムライン一覧にページネーションと最大ロード件数のウィンドウ制御を実装
- カーソルベースのページネーション（日付キーを使用した双方向ロード）
- **ページネーション仕様を最適化**

### 変更内容
- `AppConfig.swift`を新規作成してページネーション設定を集約
- `TimelinePagingState.swift`を新規作成してページング状態を管理
- `TimelineView.swift`をページネーション対応に変更

### 修正
- 長期キャッシュ全量ロードによるメモリ消費とクラッシュ問題を解決
- 大量のアーカイブイベントがある場合のパフォーマンス改善
- タイムライン一覧の「ジャーナル」ボタンタップ時に画面最上部（もう上にスクロールできない位置）にスクロールするように修正
- エントリー詳細画面から戻った際にページングが発火してスクロール位置がずれる問題を修正
- エントリー詳細画面から戻った際に同期処理が走る問題を修正
- カスタムタブバーの実装に伴うUI調整
- パフォーマンス最適化のため、初期ロード範囲を調整（今日を中心に前後30件）
- **画面下部にスクロールしてもエントリーがロードされない問題を修正**
- エントリー詳細、カレンダー詳細設定、開発者向け画面で下部コンテンツがタブバーで隠れる問題を修正（`.safeAreaInset`でタブバーの高さ分のスペースを確保）

---

## [0.19] - 2025-12-23

### 追加機能
- オンボーディング時に選択したカレンダーの長期キャッシュを自動取得
- カレンダーを表示ON（`isEnabled = true`）にした時点で長期キャッシュを自動取得
- `ArchiveImportSettings`による長期キャッシュ取得状態の管理

### 変更内容
- カレンダー設定画面から「長期キャッシュ」セクションを削除
- `CalendarSelectionOnboardingView`のオンボーディング完了時に選択されたカレンダーの長期キャッシュ取得を開始
- `CalendarSettingsView`の表示トグルON時に長期キャッシュ取得を開始
- 長期キャッシュ取得はバックグラウンドで実行され、UIには進捗を表示しない

### 修正
- 短期キャッシュから長期キャッシュへの同期時に`startMonthDayKey`と`holidayId`が更新されない問題を修正
- 関連エントリー検索の対称性の問題を修正（2006/12/23から2025/12/23が見えるが、逆方向が見えない問題）

---

## [0.18] - 2025-12-23

### 追加機能
- エントリー詳細画面に「関連するエントリー」セクションを追加（過去と未来の両方を表示）
- 同じ週の同じ曜日検索で未来10年分も検索対象に追加

### 変更内容
- `RelatedMemoriesSection`のセクションヘッダーを「関連する過去」から「関連するエントリー」に変更
- `RelatedMemoryService`で同じ年月日のエントリーを関連エントリーから除外（同じ年だけでなく同じ日も除外）
- `RelatedMemoryItem`で過去・未来の両方を表示できるように`yearsDifference`を導入
- 関連エントリーの表示を「N年前」「N年後」「今年」のように動的に変更

### 修正
- 関連エントリーに同じ日付のエントリーが表示される問題を修正

---

## [0.17] - 2025-12-23

### 追加機能
- 初期オンボーディングフローを実装

### 変更内容
- `RootView`にオンボーディング表示判定ロジックを追加

### 修正
- 初回起動時のユーザー体験を改善し、スムーズにアプリを利用開始できるように変更

---

## [0.16] - 2025-12-23

### 修正
- アプリ初期起動時に「未ログインです」のエラーメッセージが表示される問題を修正

---

## [0.15] - 2025-12-23

### 変更内容
- タイムライン一覧とエントリー詳細画面のUI改善
- カレンダー設定画面の色選択UI改善

### 修正
- タイムライン一覧と詳細画面の視認性を向上

---

## [0.14] - 2025-12-23

### 追加機能
- 検索アイコンを左上に配置し、タップで検索バーを表示する機能を追加

### 変更内容
- `TimelineView`の検索UIを改善

### 修正
- 検索機能の操作性を改善し、より直感的なUIに変更

---

## [0.13] - 2025-12-23

### 追加機能
- タイムライン一覧で「今日」を初期フォーカスし、上=未来/下=過去のスクロール体験を実現

### 変更内容
- `TimelineView`に初期フォーカス機能を追加

### 修正
- タイムライン一覧のスクロール体験を改善し、より直感的な操作を実現

---

## [0.12] - 2025-12-23

### 追加機能
- タイムライン一覧画面のメッセージ表示をtoast/snackbar形式に変更

### 変更内容
- `ToastView`コンポーネントを新規作成
- `TimelineView`のメッセージ表示を改善

### 修正
- タイムライン一覧画面のメッセージ表示を改善し、より直感的なUIに変更

---

## [0.11] - 2025-12-23

### 追加機能
- エントリー編集画面で書き込み先カレンダーを変更できる機能を追加

### 変更内容
- `JournalEditorView`にカレンダー選択機能を追加
- `CalendarPickerView`を新規作成
- `JournalCalendarSyncService.syncOne`を修正

### 修正
- 既存エントリーの書き込み先カレンダーを変更した際の404エラーを修正
- 書き込み先カレンダー変更後に詳細画面と一覧画面のカラーが反映されない問題を修正
- 保存ボタン押下時にカレンダー側と同期的に同期するように変更
- 保存ボタンにローディング表示を追加
- タグ抽出ロジックを整理し、カレンダー編集反映を安定化
- タグ検索のロジックを修正
- タイムライン一覧での重複表示を修正
- 統合カードのカラー表示を修正
- Googleカレンダー側で設定されているカラーをデフォルトで取得する機能を追加
- カレンダー設定画面を追加
- カレンダー設定画面に表示設定と長期キャッシュ取り込み機能を追加
- 同期失敗をCrashlyticsに送信する機能を追加

---

## [0.10] - 2025-12-23

### 追加機能
- 長期エントリー（ArchivedCalendarEvent）の編集機能を追加

### 変更内容
- `ArchivedCalendarEventDetailView`に編集機能を追加

---

## [0.9] - 2025-12-23

### 追加機能
- ジャーナル編集画面に書き込み先カレンダー表示機能を追加（「基本」セクションのヘッダー右側に表示）
- 統一カードの視覚的整合性を強化（色・アイコンの反映）
- カレンダーの色設定をカラーパレット表示に変更（色コードではなく視覚的な色選択）

### 変更内容
- `JournalEditorView`に書き込み先カレンダー情報を表示
- 新規エントリー作成時に作成先カレンダーの色とアイコンを自動設定
- `TimelineItem`に`colorHex`と`iconName`を追加
- `CachedCalendar`に`iconName`を追加（デフォルト値: "calendar"）
- `TimelineView`のタイムライン項目生成時に色・アイコンを設定
- `TimelineRowView`で色・アイコンを表示
- デフォルト値の統一（ミュートブルー: "#3B82F6", アイコン: "calendar"）
- `CalendarListSyncService`で既存カレンダー更新時に`iconName`が空の場合はデフォルト値を設定
- 同期状態バッジの優先順位と表示を変更
- `SettingsView`と`CalendarColorPickerView`でカレンダーの色をカラーパレット（カラーチップ）で表示
- 同期完了メッセージを3秒後に自動クリア

### 修正
- タイムライン一覧で同期完了後にグルグルアイコンが表示され続ける問題を修正

---

## [0.8] - 2025-12-23

### 追加機能
- 競合解決機能（ローカルとカレンダーの競合を検知・解決）
- 長期キャッシュ取り込みのキャンセル機能
- 開発者向けツール（設定画面でバージョンを7回タップで表示）
- 同期ログ記録機能（プライバシー保護：カレンダーIDはハッシュ化）
- Google API レート制限対応（指数バックオフ + ジッター）
- 同期状態バッジ表示（タイムライン上で競合・同期失敗を視覚化）

### 変更内容
- `JournalEntry`に競合解決用フィールド追加
- `SyncLog`モデル追加
- 各同期サービスにログ記録機能追加
- `GoogleCalendarClient`に指数バックオフ実装
- `ConflictResolutionService`新規追加
- `TimelineRowView`に同期状態バッジUI追加
- `TimelineView`に個別再送機能追加
- `SettingsView`に「同期待ち」セクション追加

### 修正
- 競合検知の誤検知防止（30秒許容）
- 長期キャッシュ取り込みのキャンセル不可問題を解決
- Google API レート制限エラーでのリトライ失敗問題を解決

---

## [0.7] - 2025-12-22

### 変更内容
- 実装準拠に全面見直し
- Google Calendarを唯一の永続データストアとして明記
- extendedProperties仕様を確定
- キャッシュ2層構造を追加
- 同期仕様を実装準拠に更新
- 開発フェーズを実装状況に合わせて更新

---

## [0.6] - 2025-12-21

### 変更内容
- タグ設計を更新（Google Calendar連携、最近使ったタグのみ表示、同期範囲の明確化）
- データ保存方針と設計上の思想を追加

---

## [0.5] - 2025-12-21

### 追加機能
- カードのカラーとアイコン選択機能を追加
- 予定・ジャーナルの完全統一を明確化

---

## [0.4] - 2025-12-20

### 変更内容
- ジャーナルカードと予定カードを統一
- フォント設定追加（Noto Sans JP / Inter）

---

## [0.3] - 2025-12-20

### 変更内容
- 2タブ構成に簡素化
- タイムラインベースのメイン画面に変更

---

## [0.2] - 2025-12-20

### 変更内容
- アプリ名変更
- 各種機能調整

---

## [0.1] - 2025-12-20

### 初版作成
- 基本仕様策定
