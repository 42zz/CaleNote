# CaleNote 変更履歴

このファイルはCaleNoteの仕様変更と実装の履歴を記録します。

## [0.27] - 2025-12-24

### 改善内容
- **カーソル方式の長期キャッシュページング**を実装
  - 有効イベントが疎でも確実に深い過去（2006年など）まで到達可能
  - 検索範囲を段階的に過去へ進める方式に変更（従来のfetchLimit倍増方式を撤廃）

- **カレンダー表示設定変更時のタイムライン初期化**を実装
  - 新しく有効化したカレンダーの予定が即座に反映される
  - 設定変更時に自動的に今日へスクロール
  - 検索中はスクロールをスキップして体験を保護

- **詳細画面復帰時のスクロール位置保持**を実装
  - 過去のエントリー詳細を開いて戻っても、スクロール位置が維持される
  - needsInitialFocusフラグで初回表示と詳細復帰を明確に区別
  - 初回表示またはタイムライン初期化時のみ「今日」へフォーカス

- **エントリー詳細でURL自動リンク化**を実装
  - https:// または http:// で始まるURLを自動検出してタップ可能なリンクに変換
  - NSDataDetectorを使用した安定したURL検出
  - タップでSafariが開く
  - 複数URL対応、末尾の句読点を除外

- **同期ステータスアイコン表示システム**を実装（トースト通知を置き換え）
  - 右下に控えめなステータスアイコンを表示（idle / syncing / success / error）
  - 成功時は1.5秒後に自動的にフェードアウト
  - エラー時はタップで再試行可能
  - アイコンをタップすると詳細情報を展開表示
  - 画面を遮らない非侵襲的なUI

- **タイムライン一覧で「昨日」「今日」「明日」セクションを強調表示**を実装
  - 昨日の日付セクションは「昨日 (2025年12月24日)」のように表示
  - 今日の日付セクションは「今日 (2025年12月25日)」のように表示
  - 明日の日付セクションは「明日 (2025年12月26日)」のように表示
  - アクセントカラー（青）で強調表示
  - 左側に小さなドット（●）を追加してタイムライン感を演出
  - 太字フォント（.semibold）で視認性向上
  - 薄い背景ハイライト（Capsule shape）で区別
  - 日付が変わった場合も自動的に正しく切り替わる

- **タブタップ時の挙動改善（TOPへ戻す / メイン詳細は保持）**を実装
  - 設定タブを再タップするとNavigationStackがリセットされ設定TOPへ戻る
  - メインタブを再タップすると従来通り「今日」へスクロール
  - メインで詳細を開いた状態で設定へ移動し、メインタブをタップして戻った場合、詳細画面が維持される
  - タブ切り替えだけでは各タブのNavigationStackは保持される

### 実装詳細
- `TimelinePagingState.fetchPastEvents`: カーソルベースのバッチ取得に変更
  - batchSize固定（limit * 5）で毎回検索範囲を過去へシフト
  - cursorDayKeyを最古日付の1日前に更新することで確実に過去方向へ進行
  - maxBatches=50で最大7,500件相当の探索を可能に

- `TimelineView.onCalendarsChanged`: タイムライン初期化ロジックを実装
  - pagingState.reset()で長期ページング状態をクリア
  - hasAutoFocusedToday/selectedDayKey/needsInitialFocusをリセット
  - scrollToToday()で今日へスクロール（検索中を除く）
  - runSync()で短期キャッシュを最新化

- `TimelineView.handleInitialFocus`: 初期フォーカス条件の厳格化
  - isDetailViewPresentedガードで詳細画面復帰時はスキップ
  - needsInitialFocusフラグで初回表示または明示的リセット時のみ実行
  - 実行後にneedsInitialFocus = falseで2度実行を防止

- `URLLinkifierUtility`: URL自動リンク化ユーティリティを実装
  - NSDataDetectorでURL検出（iOS標準のリンク検出を利用）
  - AttributedStringにリンク属性を付与
  - ParagraphTextViewで自動的にリンク化されたテキストを表示

- `SyncStatusStore`: 同期ステータス管理ストアを実装
  - @MainActor ObservableObjectで同期状態を管理
  - setSyncing() / setSuccess() / setError() / reset() の4つのAPI
  - 成功時は1.5秒後に自動的にidleに遷移
  - 詳細メッセージ（更新件数など）を保持

- `SyncStatusIndicator`: 右下ステータスアイコンビューを実装
  - タブバーの上80pxに配置（タブバー高さ60 + マージン20）
  - syncing: 青いProgressViewアイコン
  - success: 緑のチェックマークアイコン
  - error: 赤のエラーアイコン（タップで再試行）
  - タップで詳細情報を展開表示（isExpanded状態管理）

- `TimelineView.runSync`: トースト通知からステータスアイコンに移行
  - syncStatusStore.setSyncing()で同期開始を通知
  - syncStatusStore.setSuccess()で同期成功を通知（詳細情報付き）
  - syncStatusStore.setError()で同期エラーを通知
  - 削除操作のトーストは維持（ユーザー直接操作のため）

- `RootView`: 同期ステータスインジケーターをアプリ全体に統合
  - @StateObject syncStatusStoreを作成してTimelineViewに注入
  - SyncStatusIndicatorをZStackのoverlayとして配置（zIndex=99）
  - エラー時の再試行トリガー（syncRetryTrigger）をバインディングで接続

- `TimelineView`: 昨日・今日・明日の日付キー取得プロパティを追加
  - yesterdayKey: Calendar.date(byAdding: .day, value: -1) で昨日の日付キーを計算
  - todayKey: 現在の日付キー（既存）
  - tomorrowKey: Calendar.date(byAdding: .day, value: 1) で明日の日付キーを計算

- `TimelineView.timelineSection`: 昨日・今日・明日判定ロジックを実装
  - sectionDayKey と yesterdayKey / todayKey / tomorrowKey を比較
  - 三項演算子で headerTitle を生成:
    - 昨日の場合: "昨日 (日付)"
    - 今日の場合: "今日 (日付)"
    - 明日の場合: "明日 (日付)"
    - その他: 日付のみ
  - isHighlighted = isYesterday || isToday || isTomorrow で強調フラグを設定

- `TimelineSectionHeader`: 特別な日付セクション用の強調ヘッダービューを実装
  - isHighlighted = true の場合（昨日・今日・明日）:
    - 左側に6pt円形ドット（アクセントカラー）を表示
    - フォントを .headline / .semibold に変更
    - テキストカラーをアクセントカラーに変更
    - 背景に Capsule 形状の薄いハイライト（opacity 0.1）を追加
  - isHighlighted = false の場合: 従来通りのシンプルな表示

- `RootView`: タブタップ時の挙動改善を実装
  - settingsResetTrigger を新規追加（設定タブのリセット用）
  - SettingsView に .id(settingsResetTrigger) を付与
    - トリガー変更時にView全体が再生成され、NavigationStackがリセットされる
  - 設定タブボタンのロジック更新:
    - selectedTab == 1 の場合（再タップ）: settingsResetTrigger をインクリメント
    - それ以外の場合（他タブから切り替え）: selectedTab = 1 のみ
  - メインタブボタンのロジック（既存）:
    - selectedTab == 0 の場合（再タップ）: mainTabTapTrigger をインクリメント
    - それ以外の場合（他タブから切り替え）: selectedTab = 0 のみ
  - この設計により、「再タップ時のみリセット」「切り替え時は状態保持」を実現

### 受け入れ条件達成
- ✅ 2022年から2006年などの離れた年代でも継続ページング可能
- ✅ 無効カレンダーのイベントが大量にあっても有効イベントに到達
- ✅ カレンダー表示設定変更が即座に反映（再起動不要）
- ✅ 設定変更後は自動的に今日へ戻る
- ✅ 同期成功時の大きい通知が表示されない（ステータスアイコンのみ）
- ✅ 同期状態が右下の控えめなアイコンで確認可能
- ✅ エラー時はタップで再試行できる
- ✅ アイコンをタップすると詳細情報を確認できる
- ✅ タイムライン一覧で昨日のセクションが「昨日 (日付)」と表示される
- ✅ タイムライン一覧で今日のセクションが「今日 (日付)」と表示される
- ✅ タイムライン一覧で明日のセクションが「明日 (日付)」と表示される
- ✅ 昨日・今日・明日のセクションが他の日付と視覚的に区別できる（色・フォント・ドット・背景）
- ✅ 日付が変わった（0時超え）場合も、再表示で正しく切り替わる
- ✅ 過去・未来の日付表示には影響しない（昨日・今日・明日以外は従来通りの日付表記）
- ✅ 設定タブで深い画面にいる状態で設定タブをタップすると設定TOPへ戻る
- ✅ メインタブで深い画面にいる状態でメインタブを再タップするとメインTOP（今日）へ戻る
- ✅ メインで詳細を開いた状態で設定へ移動し、メインタブをタップして戻った場合、詳細画面が維持される
- ✅ 検索中の体験を保護（スクロールしない）
- ✅ 過去エントリー詳細から戻ってもスクロール位置が保持される
- ✅ 初回起動時とタイムライン初期化時は「今日」にフォーカス
- ✅ タブ再タップなどのユーザー意図操作は従来通り動作
- ✅ https:// を含む本文でURL部分だけがリンクになりタップで開ける
- ✅ 複数URLが全てリンク化される
- ✅ URL末尾の句読点がリンク範囲に含まれない
- ✅ URLがない本文は従来通りプレーンテキスト表示

## [0.26] - 2025-12-24

### 追加機能
- **過去側段階表示（2段階データソース）**を実装
- タイムライン下スクロールで長期キャッシュから過去イベントを段階的にロード
- 短期キャッシュ使い切り後、自動的に長期キャッシュからページング取得

### 変更内容
- `TimelinePagingState`を過去側専用にシンプル化して復活
- `timelineItems`で短期キャッシュ + JournalEntry + 長期キャッシュを統合表示
- uid（calendarId:eventId）による厳密な重複排除を実装
- 短期キャッシュを優先、長期キャッシュは補完用として使用

### 実装詳細
- 過去側センチネル行によるページングトリガー（onAppear方式）
- `loadPastPageIfNeeded`: 短期キャッシュの最古日付より古い長期キャッシュを取得
- `TimelinePagingState.loadPastPage`: 有効カレンダーIDでフィルタリングしながらlimit件取得
- uid重複排除：ジャーナル紐付き除外 → 短期キャッシュ重複除外 → 検索/タグフィルタ適用

### 受け入れ条件達成
- ✅ 起動時に今日へフォーカス（維持）
- ✅ 下スクロールで短期過去→長期過去へ継続表示
- ✅ 同一イベントの二重表示なし（uid排除）
- ✅ レイアウトシフトなし（センチネル行方式）
- ✅ メモリ管理（ページサイズ30件ずつ段階取得）

---

## [0.25] - 2025-12-24

### 変更内容
- エントリー詳細画面のナビゲーションタイトルに日時情報を表示するように変更
- ナビゲーションタイトルの日時表示レイアウトを改善（日付の下に時間を配置）

### 追加
- `NavigationDateTimeView`コンポーネントを追加（ナビゲーションタイトル用のコンパクトな日時表示）
- 各詳細画面（`JournalDetailView`、`CalendarEventDetailView`、`ArchivedCalendarEventDetailView`）のナビゲーションバーに日時情報を表示

### 修正
- 時間指定イベントのナビゲーションタイトル表示で、日付を1行目、時間を2行目に配置するように変更

---

## [0.24] - 2025-12-24

### 変更内容
- **タイムライン表示仕様を短期キャッシュのみに変更**
- タイムライン通常表示から長期キャッシュ（ArchivedCalendarEvent）を完全に除外
- 短期キャッシュ（CachedCalendarEvent）+ JournalEntry のみを表示対象に変更
- 長期キャッシュは検索・振り返り専用として位置付けを明確化

### 削除
- `TimelinePagingState`を使用した ArchivedCalendarEvent のページネーション機能を削除
- `loadPastPageIfNeeded`、`loadFuturePageIfNeeded`を削除
- `pagingState`、`hasInitialLoadCompleted`、`recentlyReturnedFromDetail`などの状態変数を削除
- 長期キャッシュ混在による重複・順序不整合・レイアウトシフトの問題を根本解決

### 修正
- タイムライン一覧で終日イベントの表示を改善
- `TimelineItem`に`isAllDay`プロパティを追加
- `TimelineRowView`で終日イベントの判定ロジックを追加

---

## [0.23] - 2025-12-24

### 変更内容
- エントリー詳細画面のメタ情報表示を改善
- 3つの詳細画面（`JournalDetailView`、`CalendarEventDetailView`、`ArchivedCalendarEventDetailView`）のコンポーネントを統合

### 修正
- `DetailViewUtilities.swift`に`formatSyncDateTime`関数を追加（YYYY/MM/DD HH:mm形式）
- `DetailMetadataSection`に`AdditionalMetadataItem`構造体と`additionalMetadata`パラメータを追加
- コードの重複を削減し、UIの一貫性を向上

---

## [0.22] - 2025-12-24

### 変更内容
- 関連エントリー一覧の表示仕様を改善

### 修正
- `RelatedMemoriesSection.swift`の年表示でカンマ区切りが入る問題を修正
- 年ヘッダーに相対年情報（「○年前」）を追加して時間の重みを強調
- 関連エントリー行に日付情報を明示的に表示して可読性を向上

---

## [0.21] - 2024-12-24

### 追加機能
- エントリー作成時にカレンダー側に登録するエントリーの時間を設定画面で指定できる機能を追加（デフォルト30分）

### 変更内容
- `JournalWriteSettings`にエントリー時間（分）の保存・読み込み機能を追加
- `SettingsView`に「エントリー設定」セクションを追加し、エントリー時間を1〜480分（5分刻み）で設定可能に
- `JournalCalendarSyncService`で設定値を読み込んで使用するように変更（60分のハードコードを削除）
- デフォルトの書き込み先カレンダー設定を、カレンダー詳細画面（`CalendarSettingsView`）から設定画面の「エントリー設定」セクション（`SettingsView`）に移動
- `CalendarSettingsView`から「書き込み先」セクションを削除

---

## [0.20] - 2025-12-23

### 追加機能
- タイムライン一覧にページネーションと最大ロード件数のウィンドウ制御を実装
- カーソルベースのページネーション（日付キーを使用した双方向ロード）
- **ページネーション仕様を最適化**

### 変更内容
- `AppConfig.swift`を新規作成してページネーション設定を集約
- `TimelinePagingState.swift`を新規作成してページング状態を管理
- `TimelineView.swift`をページネーション対応に変更

### 修正
- 長期キャッシュ全量ロードによるメモリ消費とクラッシュ問題を解決
- 大量のアーカイブイベントがある場合のパフォーマンス改善
- タイムライン一覧の「ジャーナル」ボタンタップ時に画面最上部（もう上にスクロールできない位置）にスクロールするように修正
- エントリー詳細画面から戻った際にページングが発火してスクロール位置がずれる問題を修正
- エントリー詳細画面から戻った際に同期処理が走る問題を修正
- カスタムタブバーの実装に伴うUI調整
- パフォーマンス最適化のため、初期ロード範囲を調整（今日を中心に前後30件）
- **画面下部にスクロールしてもエントリーがロードされない問題を修正**
- エントリー詳細、カレンダー詳細設定、開発者向け画面で下部コンテンツがタブバーで隠れる問題を修正（`.safeAreaInset`でタブバーの高さ分のスペースを確保）

---

## [0.19] - 2025-12-23

### 追加機能
- オンボーディング時に選択したカレンダーの長期キャッシュを自動取得
- カレンダーを表示ON（`isEnabled = true`）にした時点で長期キャッシュを自動取得
- `ArchiveImportSettings`による長期キャッシュ取得状態の管理

### 変更内容
- カレンダー設定画面から「長期キャッシュ」セクションを削除
- `CalendarSelectionOnboardingView`のオンボーディング完了時に選択されたカレンダーの長期キャッシュ取得を開始
- `CalendarSettingsView`の表示トグルON時に長期キャッシュ取得を開始
- 長期キャッシュ取得はバックグラウンドで実行され、UIには進捗を表示しない

### 修正
- 短期キャッシュから長期キャッシュへの同期時に`startMonthDayKey`と`holidayId`が更新されない問題を修正
- 関連エントリー検索の対称性の問題を修正（2006/12/23から2025/12/23が見えるが、逆方向が見えない問題）

---

## [0.18] - 2025-12-23

### 追加機能
- エントリー詳細画面に「関連するエントリー」セクションを追加（過去と未来の両方を表示）
- 同じ週の同じ曜日検索で未来10年分も検索対象に追加

### 変更内容
- `RelatedMemoriesSection`のセクションヘッダーを「関連する過去」から「関連するエントリー」に変更
- `RelatedMemoryService`で同じ年月日のエントリーを関連エントリーから除外（同じ年だけでなく同じ日も除外）
- `RelatedMemoryItem`で過去・未来の両方を表示できるように`yearsDifference`を導入
- 関連エントリーの表示を「N年前」「N年後」「今年」のように動的に変更

### 修正
- 関連エントリーに同じ日付のエントリーが表示される問題を修正

---

## [0.17] - 2025-12-23

### 追加機能
- 初期オンボーディングフローを実装

### 変更内容
- `RootView`にオンボーディング表示判定ロジックを追加

### 修正
- 初回起動時のユーザー体験を改善し、スムーズにアプリを利用開始できるように変更

---

## [0.16] - 2025-12-23

### 修正
- アプリ初期起動時に「未ログインです」のエラーメッセージが表示される問題を修正

---

## [0.15] - 2025-12-23

### 変更内容
- タイムライン一覧とエントリー詳細画面のUI改善
- カレンダー設定画面の色選択UI改善

### 修正
- タイムライン一覧と詳細画面の視認性を向上

---

## [0.14] - 2025-12-23

### 追加機能
- 検索アイコンを左上に配置し、タップで検索バーを表示する機能を追加

### 変更内容
- `TimelineView`の検索UIを改善

### 修正
- 検索機能の操作性を改善し、より直感的なUIに変更

---

## [0.13] - 2025-12-23

### 追加機能
- タイムライン一覧で「今日」を初期フォーカスし、上=未来/下=過去のスクロール体験を実現

### 変更内容
- `TimelineView`に初期フォーカス機能を追加

### 修正
- タイムライン一覧のスクロール体験を改善し、より直感的な操作を実現

---

## [0.12] - 2025-12-23

### 追加機能
- タイムライン一覧画面のメッセージ表示をtoast/snackbar形式に変更

### 変更内容
- `ToastView`コンポーネントを新規作成
- `TimelineView`のメッセージ表示を改善

### 修正
- タイムライン一覧画面のメッセージ表示を改善し、より直感的なUIに変更

---

## [0.11] - 2025-12-23

### 追加機能
- エントリー編集画面で書き込み先カレンダーを変更できる機能を追加

### 変更内容
- `JournalEditorView`にカレンダー選択機能を追加
- `CalendarPickerView`を新規作成
- `JournalCalendarSyncService.syncOne`を修正

### 修正
- 既存エントリーの書き込み先カレンダーを変更した際の404エラーを修正
- 書き込み先カレンダー変更後に詳細画面と一覧画面のカラーが反映されない問題を修正
- 保存ボタン押下時にカレンダー側と同期的に同期するように変更
- 保存ボタンにローディング表示を追加
- タグ抽出ロジックを整理し、カレンダー編集反映を安定化
- タグ検索のロジックを修正
- タイムライン一覧での重複表示を修正
- 統合カードのカラー表示を修正
- Googleカレンダー側で設定されているカラーをデフォルトで取得する機能を追加
- カレンダー設定画面を追加
- カレンダー設定画面に表示設定と長期キャッシュ取り込み機能を追加
- 同期失敗をCrashlyticsに送信する機能を追加

---

## [0.10] - 2025-12-23

### 追加機能
- 長期エントリー（ArchivedCalendarEvent）の編集機能を追加

### 変更内容
- `ArchivedCalendarEventDetailView`に編集機能を追加

---

## [0.9] - 2025-12-23

### 追加機能
- ジャーナル編集画面に書き込み先カレンダー表示機能を追加（「基本」セクションのヘッダー右側に表示）
- 統一カードの視覚的整合性を強化（色・アイコンの反映）
- カレンダーの色設定をカラーパレット表示に変更（色コードではなく視覚的な色選択）

### 変更内容
- `JournalEditorView`に書き込み先カレンダー情報を表示
- 新規エントリー作成時に作成先カレンダーの色とアイコンを自動設定
- `TimelineItem`に`colorHex`と`iconName`を追加
- `CachedCalendar`に`iconName`を追加（デフォルト値: "calendar"）
- `TimelineView`のタイムライン項目生成時に色・アイコンを設定
- `TimelineRowView`で色・アイコンを表示
- デフォルト値の統一（ミュートブルー: "#3B82F6", アイコン: "calendar"）
- `CalendarListSyncService`で既存カレンダー更新時に`iconName`が空の場合はデフォルト値を設定
- 同期状態バッジの優先順位と表示を変更
- `SettingsView`と`CalendarColorPickerView`でカレンダーの色をカラーパレット（カラーチップ）で表示
- 同期完了メッセージを3秒後に自動クリア

### 修正
- タイムライン一覧で同期完了後にグルグルアイコンが表示され続ける問題を修正

---

## [0.8] - 2025-12-23

### 追加機能
- 競合解決機能（ローカルとカレンダーの競合を検知・解決）
- 長期キャッシュ取り込みのキャンセル機能
- 開発者向けツール（設定画面でバージョンを7回タップで表示）
- 同期ログ記録機能（プライバシー保護：カレンダーIDはハッシュ化）
- Google API レート制限対応（指数バックオフ + ジッター）
- 同期状態バッジ表示（タイムライン上で競合・同期失敗を視覚化）

### 変更内容
- `JournalEntry`に競合解決用フィールド追加
- `SyncLog`モデル追加
- 各同期サービスにログ記録機能追加
- `GoogleCalendarClient`に指数バックオフ実装
- `ConflictResolutionService`新規追加
- `TimelineRowView`に同期状態バッジUI追加
- `TimelineView`に個別再送機能追加
- `SettingsView`に「同期待ち」セクション追加

### 修正
- 競合検知の誤検知防止（30秒許容）
- 長期キャッシュ取り込みのキャンセル不可問題を解決
- Google API レート制限エラーでのリトライ失敗問題を解決

---

## [0.7] - 2025-12-22

### 変更内容
- 実装準拠に全面見直し
- Google Calendarを唯一の永続データストアとして明記
- extendedProperties仕様を確定
- キャッシュ2層構造を追加
- 同期仕様を実装準拠に更新
- 開発フェーズを実装状況に合わせて更新

---

## [0.6] - 2025-12-21

### 変更内容
- タグ設計を更新（Google Calendar連携、最近使ったタグのみ表示、同期範囲の明確化）
- データ保存方針と設計上の思想を追加

---

## [0.5] - 2025-12-21

### 追加機能
- カードのカラーとアイコン選択機能を追加
- 予定・ジャーナルの完全統一を明確化

---

## [0.4] - 2025-12-20

### 変更内容
- ジャーナルカードと予定カードを統一
- フォント設定追加（Noto Sans JP / Inter）

---

## [0.3] - 2025-12-20

### 変更内容
- 2タブ構成に簡素化
- タイムラインベースのメイン画面に変更

---

## [0.2] - 2025-12-20

### 変更内容
- アプリ名変更
- 各種機能調整

---

## [0.1] - 2025-12-20

### 初版作成
- 基本仕様策定
