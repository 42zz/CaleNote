# CaleNote 変更履歴

このファイルはCaleNoteの仕様変更と実装の履歴を記録します。

## [0.16] - 2025-12-23

### 修正
- アプリ初期起動時に「未ログインです」のエラーメッセージが表示される問題を修正
  - `TimelineView`の`runSync`関数で、初期起動時（自動同期）に未ログインの場合はエラーメッセージを表示しないように変更
  - 手動同期時（pull-to-refresh）に未ログインの場合は、情報メッセージとして「ログインが必要です」を表示
  - これにより、アプリ起動時の正常な状態（未ログイン）でエラーメッセージが表示されなくなり、UXが改善

---

## [0.15] - 2025-12-23

### 変更内容
- タイムライン一覧とエントリー詳細画面のUI改善
  - アイコンを非表示にし、カレンダーの色をカラーバーで表示
  - タイムライン一覧: カード左側に4px幅のカラーバーを表示
  - 詳細画面: ヘッダー部分に4px幅のカラーバーを表示
  - 視認性とUIUXの改善を目的とした変更
- カレンダー設定画面の色選択UI改善
  - カラーコード表示を削除
  - グリッドレイアウト（5x5 = 25色）に変更
  - カラーチップサイズを44pxに拡大
  - 選択中の色は太いボーダー（3px）と白いチェックマークで強調表示
  - カラーパレットをGoogleカレンダーの標準色をベースに変更（24色から25色を選択）
    - Google Calendar APIの標準カラーパレットを参照
    - 赤、オレンジ、黄色、緑、シアン、青、紫、ピンク、茶色、グレーなどの系統から選択

### 修正
- タイムライン一覧と詳細画面の視認性を向上

---

## [0.14] - 2025-12-23

### 追加機能
- 検索アイコンを左上に配置し、タップで検索バーを表示する機能を追加
  - ツールバーの左上に検索アイコン（🔍）を配置
  - 検索アイコンをタップすると検索バーがドロワー形式で表示される
  - 検索バーの表示状態を`isSearchPresented`で管理

### 変更内容
- `TimelineView`の検索UIを改善
  - `.searchable`に`isPresented: $isSearchPresented`パラメータを追加
  - ツールバーに`.topBarLeading`で検索アイコンを追加
  - 検索アイコンをタップすると`isSearchPresented = true`で検索バーを表示
  - 検索バーはiOS標準のドロワー形式で表示

### 修正
- 検索機能の操作性を改善し、より直感的なUIに変更

---

## [0.13] - 2025-12-23

### 追加機能
- タイムライン一覧で「今日」を初期フォーカスし、上=未来/下=過去のスクロール体験を実現
  - 初回表示時に「今日セクション」に自動スクロール
  - 上へスクロールすると未来日付（明日以降）へ、下へスクロールすると過去日付（前日以前）へ自然に移動
  - 日付セクションごとにYYYYMMDD形式のanchorIdを付与（ScrollViewReader使用）
  - 今日セクションが存在しない場合でも空セクションを生成してフォーカス可能に
  - 検索中は自動フォーカスを無効化（検索結果の先頭表示を維持）
  - 日付ジャンプ機能との統合準備（selectedDayKeyによる優先フォーカス）

### 変更内容
- `TimelineView`に初期フォーカス機能を追加
  - `ScrollViewReader`で`List`をラップ
  - 日付セクションに`.id(dayKey)`を付与（YYYYMMDD形式のString）
  - `hasAutoFocusedToday`で初回表示のみ自動スクロールを実行
  - `selectedDayKey`で日付ジャンプ後のフォーカスを管理（将来の機能統合用）
  - `groupedItems`で今日セクションが存在しない場合は空セクションを生成
  - 空セクションには「記録がありません」のプレースホルダーを表示
  - `onAppear`で検索中でない場合のみ自動フォーカスを実行
  - `onChange(of: selectedDayKey)`で日付ジャンプ後のスクロールを処理

### 修正
- タイムライン一覧のスクロール体験を改善し、より直感的な操作を実現

---

## [0.12] - 2025-12-23

### 追加機能
- タイムライン一覧画面のメッセージ表示をtoast/snackbar形式に変更
  - 同期状態、同期エラー、削除エラーなどのメッセージを画面下部にtoast形式で表示
  - メッセージタイプ（info/success/error/warning）に応じた色とアイコンを表示
  - 自動消去機能（4秒後に自動で消える）

### 変更内容
- `ToastView`コンポーネントを新規作成
  - toast/snackbar形式のメッセージ表示コンポーネント
  - タイプ（info/success/error/warning）に応じた背景色とアイコン
  - アニメーション付きで表示/非表示
  - 画面下部に表示
- `TimelineView`のメッセージ表示を改善
  - 同期状態・エラーメッセージの`Section`を削除
  - `.toast` modifierを使用してtoast表示に統合
  - 以下のメッセージをtoastで表示：
    - 同期中メッセージ（info）
    - 同期完了メッセージ（success、最終同期時間を含む）
    - 同期エラーメッセージ（error）
    - 削除成功/エラーメッセージ（success/error）
    - 再送成功/エラーメッセージ（success/error）
    - レート制限警告（warning）

### 修正
- タイムライン一覧画面のメッセージ表示を改善し、より直感的なUIに変更

---

## [0.11] - 2025-12-23

### 追加機能
- エントリー編集画面で書き込み先カレンダーを変更できる機能を追加
  - 書き込み先カレンダー表示部分をタップでカレンダー選択シートを表示
  - カレンダー一覧から選択可能（有効なカレンダーのみ表示）
  - 既存エントリの場合は`linkedCalendarId`を更新
  - 新規エントリの場合は選択したカレンダーに保存

### 変更内容
- `JournalEditorView`にカレンダー選択機能を追加
  - 書き込み先カレンダー表示を`Button`に変更
  - `CalendarPickerView`を新規作成
  - 選択したカレンダーIDを`@State`で管理
  - 保存時に選択したカレンダーIDを使用して同期
- `CalendarPickerView`を新規作成
  - カレンダー一覧を表示
  - 各カレンダーの色とアイコンを表示
  - 選択中のカレンダーにチェックマークを表示
- `JournalCalendarSyncService.syncOne`を修正
  - カレンダーIDが変更された場合、古いカレンダーのイベントを削除してから新しいカレンダーに作成
  - 古いカレンダーのキャッシュ（短期・長期）も削除
  - 404エラーは「すでに削除済み」として無視

### 修正
- 既存エントリーの書き込み先カレンダーを変更した際の404エラーを修正
  - `JournalEditorView`で`linkedCalendarId`を更新する前に`syncOne`を呼び出すように変更
  - `syncOne`内で古いカレンダーIDを保存してから削除処理を実行
  - `updateEvent`の条件に`oldCalendarId == targetCalendarId`を追加し、カレンダー変更時は`updateEvent`が呼ばれないように修正
- 書き込み先カレンダー変更後に詳細画面と一覧画面のカラーが反映されない問題を修正
  - `JournalCalendarSyncService.syncOne`で、カレンダー変更時または新規作成時に新しいカレンダーの色とアイコンをエントリに設定
  - `JournalDetailView`で、カレンダーIDではなくカレンダー名を表示
- 保存ボタン押下時にカレンダー側と同期的に同期するように変更
  - `JournalEditorView`の`save()`メソッドで、`syncOne`を`await`で同期的に実行
  - 同期が完了してから画面を閉じるように変更
  - これにより、保存直後に詳細画面に戻っても最新のカレンダー情報が表示される
- 保存ボタンにローディング表示を追加
  - `isSaving`が`true`の時、保存ボタンに`ProgressView()`と「保存中...」テキストを表示
  - 保存処理中であることを視覚的に示す
- タグ抽出ロジックを整理し、カレンダー編集反映を安定化
  - `buildTagStats`を修正して、`JournalEntry`と同期対象期間内の`CachedCalendarEvent`の両方からタグを抽出
  - カレンダー側で`description`が編集された場合、同期でキャッシュが更新されるとタグ統計に自動反映
  - 同期対象期間内のイベントのみを対象（`SyncSettings.windowDates()`を使用）
  - `JournalEntry`と紐付いているイベントは重複カウントを避けるため除外
  - 検索機能（`#tag`検索）は既存仕様どおり維持（`JournalEntry`のみを対象）
  - 有効なカレンダー（`isEnabled == true`）のイベントのみを対象にし、表示OFFにしたカレンダーのタグは表示されないように修正
- タグ検索のロジックを修正
  - `timelineItems`でカレンダーイベント（`CachedCalendarEvent`と`ArchivedCalendarEvent`）にもタグフィルタリングを適用
  - タグを選択した時に、ジャーナルエントリだけでなく、カレンダーイベントもタグでフィルタリングされるように修正
- タイムライン一覧での重複表示を修正
  - 重複排除ロジックを強化し、`linkedJournalId`と`linkedEventId`/`linkedCalendarId`の両方でチェック
  - 表示対象のジャーナルに対応するカレンダーイベントを明示的に除外
  - これにより、同じエントリーが重複表示される問題を解決
- 統合カードのカラー表示を修正
  - `journalItems`で、`entry.colorHex`が空文字列やデフォルト値（`#3B82F6`）の場合、カレンダーの色を使用するように修正
  - `calendarItems`と`archivedItems`で、カレンダーの色が空文字列の場合の処理を追加
  - これにより、過去のエントリーでもカレンダーの色が正しく表示される
- Googleカレンダー側で設定されているカラーをデフォルトで取得する機能を追加
  - `GoogleCalendarClient`に`colorIdToHex`メソッドを追加し、Google Calendar APIのカラーIDからカラーコード（HEX）に変換
  - `CalendarListSyncService`で、新規カレンダー作成時や`userColorHex`がデフォルト値の場合、Googleカレンダーのカラーを自動設定
  - これにより、Googleカレンダー側で設定されているカラーがデフォルトとして使用される
- カレンダー設定画面を追加
  - `CalendarSettingsView`を新規作成し、カレンダーの色とアイコンを設定できる画面を追加
  - 設定画面の「表示するカレンダー」セクションでカレンダーをタップすると、カレンダー設定画面に遷移
  - カレンダー設定画面では、色とアイコンの両方を設定可能
  - 「カレンダーの色」セクションを削除し、「表示するカレンダー」セクションに統合
- カレンダー設定画面に表示設定と長期キャッシュ取り込み機能を追加
  - カレンダーの表示ON/OFFを設定画面から切り替え可能
  - デフォルトの書き込み先を設定画面から切り替え可能
  - 各カレンダーごとに長期キャッシュを取り込めるように機能追加
  - 長期キャッシュ取り込み中は進捗表示とキャンセル機能を提供
- 同期失敗をCrashlyticsに送信する機能を追加
  - `SyncErrorReporter`を新規作成し、同期失敗をCrashlyticsに送信
  - 送信情報: 失敗種別、対象カレンダーIDのハッシュ、HTTPコード、syncTokenフォールバック有無、処理フェーズ（短期/長期/再送）
  - ユーザーコンテンツ（本文、タイトルなど）は送信しない
  - 各同期サービス（`CalendarSyncService`、`JournalCalendarSyncService`、`ArchiveSyncService`、`CalendarListSyncService`）のエラーハンドリングで自動送信
  - Firebase Crashlyticsが設定されていない場合はログ出力のみ（条件付きコンパイル）

---

## [0.10] - 2025-12-23

### 追加機能
- 長期エントリー（ArchivedCalendarEvent）の編集機能を追加
  - 長期キャッシュのイベント詳細画面に編集ボタンを追加
  - 既にジャーナルと紐付いている場合はそのジャーナルを編集
  - 紐付いていない場合は新規ジャーナルを作成してリンク

### 変更内容
- `ArchivedCalendarEventDetailView`に編集機能を追加
  - `CalendarEventDetailView`と同じロジックで実装
  - 編集ボタンから`JournalEditorView`を開く
  - ジャーナルとアーカイブイベントの双方向リンクを維持

---

## [0.9] - 2025-12-23

### 追加機能
- ジャーナル編集画面に書き込み先カレンダー表示機能を追加（「基本」セクションのヘッダー右側に表示）
- 統一カードの視覚的整合性を強化（色・アイコンの反映）
- カレンダーの色設定をカラーパレット表示に変更（色コードではなく視覚的な色選択）

### 変更内容
- `JournalEditorView`に書き込み先カレンダー情報を表示
  - 既存エントリ: `linkedCalendarId`から該当カレンダーを表示
  - 新規作成時: `JournalWriteSettings`の選択値を表示
  - カレンダー名、色、アイコンを表示
  - 「基本」セクションのヘッダー右側に小さく表示
- 新規エントリー作成時に作成先カレンダーの色とアイコンを自動設定
- `TimelineItem`に`colorHex`と`iconName`を追加
- `CachedCalendar`に`iconName`を追加（デフォルト値: "calendar"）
- `TimelineView`のタイムライン項目生成時に色・アイコンを設定
  - カレンダーイベント: `CachedCalendar`の`userColorHex`/`iconName`を反映
  - ジャーナル: `colorHex`はエントリ固有、`iconName`は所属カレンダー（`linkedCalendarId`）の設定を反映
- `TimelineRowView`で色・アイコンを表示
  - 背景色、アイコン、サブテキスト（時間）の整合を確保
  - 統一カードの視覚的整合性を維持
- デフォルト値の統一（ミュートブルー: "#3B82F6", アイコン: "calendar"）
- `CalendarListSyncService`で既存カレンダー更新時に`iconName`が空の場合はデフォルト値を設定
- 同期状態バッジの優先順位と表示を変更
  - 優先順位: 同期中 → 競合 → 同期失敗 → 同期済み（何も表示しない）
  - 同期中: `arrow.triangle.2.circlepath`アイコンを回転アニメーション付きで表示
  - 同期済み: バッジを表示しない（以前は同期済みバッジを表示していた）
- `SettingsView`と`CalendarColorPickerView`でカレンダーの色をカラーパレット（カラーチップ）で表示
- 同期完了メッセージを3秒後に自動クリア

### 修正
- タイムライン一覧で同期完了後にグルグルアイコンが表示され続ける問題を修正

---

## [0.8] - 2025-12-23

### 追加機能
- 競合解決機能（ローカルとカレンダーの競合を検知・解決）
- 長期キャッシュ取り込みのキャンセル機能
- 開発者向けツール（設定画面でバージョンを7回タップで表示）
- 同期ログ記録機能（プライバシー保護：カレンダーIDはハッシュ化）
- Google API レート制限対応（指数バックオフ + ジッター）
- 同期状態バッジ表示（タイムライン上で競合・同期失敗を視覚化）

### 変更内容
- `JournalEntry`に競合解決用フィールド追加
- `SyncLog`モデル追加
- 各同期サービスにログ記録機能追加
- `GoogleCalendarClient`に指数バックオフ実装
- `ConflictResolutionService`新規追加
- `TimelineRowView`に同期状態バッジUI追加
- `TimelineView`に個別再送機能追加
- `SettingsView`に「同期待ち」セクション追加

### 修正
- 競合検知の誤検知防止（30秒許容）
- 長期キャッシュ取り込みのキャンセル不可問題を解決
- Google API レート制限エラーでのリトライ失敗問題を解決

---

## [0.7] - 2025-12-22

### 変更内容
- 実装準拠に全面見直し
- Google Calendarを唯一の永続データストアとして明記
- extendedProperties仕様を確定
- キャッシュ2層構造を追加
- 同期仕様を実装準拠に更新
- 開発フェーズを実装状況に合わせて更新

---

## [0.6] - 2025-12-21

### 変更内容
- タグ設計を更新（Google Calendar連携、最近使ったタグのみ表示、同期範囲の明確化）
- データ保存方針と設計上の思想を追加

---

## [0.5] - 2025-12-21

### 追加機能
- カードのカラーとアイコン選択機能を追加
- 予定・ジャーナルの完全統一を明確化

---

## [0.4] - 2025-12-20

### 変更内容
- ジャーナルカードと予定カードを統一
- フォント設定追加（Noto Sans JP / Inter）

---

## [0.3] - 2025-12-20

### 変更内容
- 2タブ構成に簡素化
- タイムラインベースのメイン画面に変更

---

## [0.2] - 2025-12-20

### 変更内容
- アプリ名変更
- 各種機能調整

---

## [0.1] - 2025-12-20

### 初版作成
- 基本仕様策定
