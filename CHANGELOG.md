# CaleNote 変更履歴

このファイルはCaleNoteの仕様変更と実装の履歴を記録します。

## [0.11] - 2025-12-23

### 追加機能
- エントリー編集画面で書き込み先カレンダーを変更できる機能を追加
  - 書き込み先カレンダー表示部分をタップでカレンダー選択シートを表示
  - カレンダー一覧から選択可能（有効なカレンダーのみ表示）
  - 既存エントリの場合は`linkedCalendarId`を更新
  - 新規エントリの場合は選択したカレンダーに保存

### 変更内容
- `JournalEditorView`にカレンダー選択機能を追加
  - 書き込み先カレンダー表示を`Button`に変更
  - `CalendarPickerView`を新規作成
  - 選択したカレンダーIDを`@State`で管理
  - 保存時に選択したカレンダーIDを使用して同期
- `CalendarPickerView`を新規作成
  - カレンダー一覧を表示
  - 各カレンダーの色とアイコンを表示
  - 選択中のカレンダーにチェックマークを表示
- `JournalCalendarSyncService.syncOne`を修正
  - カレンダーIDが変更された場合、古いカレンダーのイベントを削除してから新しいカレンダーに作成
  - 古いカレンダーのキャッシュ（短期・長期）も削除
  - 404エラーは「すでに削除済み」として無視

### 修正
- 既存エントリーの書き込み先カレンダーを変更した際の404エラーを修正
  - `JournalEditorView`で`linkedCalendarId`を更新する前に`syncOne`を呼び出すように変更
  - `syncOne`内で古いカレンダーIDを保存してから削除処理を実行
  - `updateEvent`の条件に`oldCalendarId == targetCalendarId`を追加し、カレンダー変更時は`updateEvent`が呼ばれないように修正
- 書き込み先カレンダー変更後に詳細画面と一覧画面のカラーが反映されない問題を修正
  - `JournalCalendarSyncService.syncOne`で、カレンダー変更時または新規作成時に新しいカレンダーの色とアイコンをエントリに設定
  - `JournalDetailView`で、カレンダーIDではなくカレンダー名を表示
- 保存ボタン押下時にカレンダー側と同期的に同期するように変更
  - `JournalEditorView`の`save()`メソッドで、`syncOne`を`await`で同期的に実行
  - 同期が完了してから画面を閉じるように変更
  - これにより、保存直後に詳細画面に戻っても最新のカレンダー情報が表示される
- 保存ボタンにローディング表示を追加
  - `isSaving`が`true`の時、保存ボタンに`ProgressView()`と「保存中...」テキストを表示
  - 保存処理中であることを視覚的に示す
- タグ抽出ロジックを整理し、カレンダー編集反映を安定化
  - `buildTagStats`を修正して、`JournalEntry`と同期対象期間内の`CachedCalendarEvent`の両方からタグを抽出
  - カレンダー側で`description`が編集された場合、同期でキャッシュが更新されるとタグ統計に自動反映
  - 同期対象期間内のイベントのみを対象（`SyncSettings.windowDates()`を使用）
  - `JournalEntry`と紐付いているイベントは重複カウントを避けるため除外
  - 検索機能（`#tag`検索）は既存仕様どおり維持（`JournalEntry`のみを対象）
  - 有効なカレンダー（`isEnabled == true`）のイベントのみを対象にし、表示OFFにしたカレンダーのタグは表示されないように修正
- タグ検索のロジックを修正
  - `timelineItems`でカレンダーイベント（`CachedCalendarEvent`と`ArchivedCalendarEvent`）にもタグフィルタリングを適用
  - タグを選択した時に、ジャーナルエントリだけでなく、カレンダーイベントもタグでフィルタリングされるように修正

---

## [0.10] - 2025-12-23

### 追加機能
- 長期エントリー（ArchivedCalendarEvent）の編集機能を追加
  - 長期キャッシュのイベント詳細画面に編集ボタンを追加
  - 既にジャーナルと紐付いている場合はそのジャーナルを編集
  - 紐付いていない場合は新規ジャーナルを作成してリンク

### 変更内容
- `ArchivedCalendarEventDetailView`に編集機能を追加
  - `CalendarEventDetailView`と同じロジックで実装
  - 編集ボタンから`JournalEditorView`を開く
  - ジャーナルとアーカイブイベントの双方向リンクを維持

---

## [0.9] - 2025-12-23

### 追加機能
- ジャーナル編集画面に書き込み先カレンダー表示機能を追加（「基本」セクションのヘッダー右側に表示）
- 統一カードの視覚的整合性を強化（色・アイコンの反映）
- カレンダーの色設定をカラーパレット表示に変更（色コードではなく視覚的な色選択）

### 変更内容
- `JournalEditorView`に書き込み先カレンダー情報を表示
  - 既存エントリ: `linkedCalendarId`から該当カレンダーを表示
  - 新規作成時: `JournalWriteSettings`の選択値を表示
  - カレンダー名、色、アイコンを表示
  - 「基本」セクションのヘッダー右側に小さく表示
- 新規エントリー作成時に作成先カレンダーの色とアイコンを自動設定
- `TimelineItem`に`colorHex`と`iconName`を追加
- `CachedCalendar`に`iconName`を追加（デフォルト値: "calendar"）
- `TimelineView`のタイムライン項目生成時に色・アイコンを設定
  - カレンダーイベント: `CachedCalendar`の`userColorHex`/`iconName`を反映
  - ジャーナル: `colorHex`はエントリ固有、`iconName`は所属カレンダー（`linkedCalendarId`）の設定を反映
- `TimelineRowView`で色・アイコンを表示
  - 背景色、アイコン、サブテキスト（時間）の整合を確保
  - 統一カードの視覚的整合性を維持
- デフォルト値の統一（ミュートブルー: "#3B82F6", アイコン: "calendar"）
- `CalendarListSyncService`で既存カレンダー更新時に`iconName`が空の場合はデフォルト値を設定
- 同期状態バッジの優先順位と表示を変更
  - 優先順位: 同期中 → 競合 → 同期失敗 → 同期済み（何も表示しない）
  - 同期中: `arrow.triangle.2.circlepath`アイコンを回転アニメーション付きで表示
  - 同期済み: バッジを表示しない（以前は同期済みバッジを表示していた）
- `SettingsView`と`CalendarColorPickerView`でカレンダーの色をカラーパレット（カラーチップ）で表示
- 同期完了メッセージを3秒後に自動クリア

### 修正
- タイムライン一覧で同期完了後にグルグルアイコンが表示され続ける問題を修正

---

## [0.8] - 2025-12-23

### 追加機能
- 競合解決機能（ローカルとカレンダーの競合を検知・解決）
- 長期キャッシュ取り込みのキャンセル機能
- 開発者向けツール（設定画面でバージョンを7回タップで表示）
- 同期ログ記録機能（プライバシー保護：カレンダーIDはハッシュ化）
- Google API レート制限対応（指数バックオフ + ジッター）
- 同期状態バッジ表示（タイムライン上で競合・同期失敗を視覚化）

### 変更内容
- `JournalEntry`に競合解決用フィールド追加
- `SyncLog`モデル追加
- 各同期サービスにログ記録機能追加
- `GoogleCalendarClient`に指数バックオフ実装
- `ConflictResolutionService`新規追加
- `TimelineRowView`に同期状態バッジUI追加
- `TimelineView`に個別再送機能追加
- `SettingsView`に「同期待ち」セクション追加

### 修正
- 競合検知の誤検知防止（30秒許容）
- 長期キャッシュ取り込みのキャンセル不可問題を解決
- Google API レート制限エラーでのリトライ失敗問題を解決

---

## [0.7] - 2025-12-22

### 変更内容
- 実装準拠に全面見直し
- Google Calendarを唯一の永続データストアとして明記
- extendedProperties仕様を確定
- キャッシュ2層構造を追加
- 同期仕様を実装準拠に更新
- 開発フェーズを実装状況に合わせて更新

---

## [0.6] - 2025-12-21

### 変更内容
- タグ設計を更新（Google Calendar連携、最近使ったタグのみ表示、同期範囲の明確化）
- データ保存方針と設計上の思想を追加

---

## [0.5] - 2025-12-21

### 追加機能
- カードのカラーとアイコン選択機能を追加
- 予定・ジャーナルの完全統一を明確化

---

## [0.4] - 2025-12-20

### 変更内容
- ジャーナルカードと予定カードを統一
- フォント設定追加（Noto Sans JP / Inter）

---

## [0.3] - 2025-12-20

### 変更内容
- 2タブ構成に簡素化
- タイムラインベースのメイン画面に変更

---

## [0.2] - 2025-12-20

### 変更内容
- アプリ名変更
- 各種機能調整

---

## [0.1] - 2025-12-20

### 初版作成
- 基本仕様策定
